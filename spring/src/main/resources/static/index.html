<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JeongGiJu - Í≥µÍ∞ú Ïπ¥ÌÖåÍ≥†Î¶¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #fff;
            color: #333;
            padding: 32px 36px;
            min-height: 100vh;
        }

        .header {
            margin-bottom: 15px;
        }

        .greeting {
            font-size: 32px;
            font-weight: normal;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 13px;
            color: #666;
            font-weight: normal;
        }

        .top-actions {
            position: absolute;
            top: 40px;
            right: 60px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            padding: 6px 12px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            text-decoration: none;
            color: #333;
            display: inline-block;
        }

        .btn:hover {
            background: #f0f0f0;
        }

        .btn-primary {
            background: #e0e0e0;
            border-color: #999;
        }

        .btn-primary:hover {
            background: #d0d0d0;
        }

        .language-toggle {
            padding: 6px 12px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-size: 13px;
        }

        .language-toggle:hover {
            background: #f0f0f0;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .category-card {
            border: 1px solid #ddd;
            padding: 16px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-card:hover {
            background: #fafafa;
            border-color: #999;
        }

        .category-card.active {
            background: #f5f5f5;
            border-color: #666;
        }

        .category-card.active .category-meta {
            color: #666;
        }

        .category-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #000;
        }

        .category-type {
            display: inline-block;
            padding: 3px 8px;
            background: #e8e8e8;
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #666;
            text-transform: uppercase;
        }

        .category-card.active .category-type {
            background: #d0d0d0;
            color: #333;
        }

        .category-meta {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        .category-actions {
            margin-top: 10px;
            display: flex;
            gap: 6px;
            padding-top: 8px;
            border-top: 1px solid #e8e8e8;
        }

        .category-card.active .category-actions {
            border-top-color: #d0d0d0;
        }

        .category-action-btn {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .category-action-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .category-card.active .category-action-btn {
            background: #fff;
            border-color: #ccc;
        }

        .category-card.active .category-action-btn:hover {
            background: #fafafa;
            border-color: #999;
        }

        .like-btn.liked .like-icon {
            color: #ff0000;
        }

        .like-icon {
            font-size: 15px;
            line-height: 1;
            transition: color 0.2s;
            display: inline-block;
            vertical-align: middle;
        }

        .like-count {
            font-size: 11px;
            color: #666;
            vertical-align: middle;
        }

        .comment-btn {
            border-color: #ddd;
            color: #666;
        }

        .comment-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .category-description {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .records-section {
            margin-top: 40px;
            padding: 30px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
            font-size: 14px;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .toggle-btn {
            padding: 6px 14px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        .toggle-btn.active {
            background: #333;
            color: #fff;
            border-color: #333;
        }

        /* Î°úÍ∑∏Ïù∏ ÏÑπÏÖò Ïä§ÌÉÄÏùº */
        .simple-auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: #f5f5f5;
            padding: 20px;
        }

        .simple-auth-box {
            background: white;
            padding: 35px 45px;
            border: 1px solid #ddd;
            min-width: 420px;
            max-width: 480px;
        }

        /* ÌÖåÏù¥Î∏î Ïä§ÌÉÄÏùº */
        .check-table, .time-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .check-table td, .time-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .date-cell {
            font-weight: 500;
            font-size: 13px;
            color: #333;
        }

        .result-cell {
            font-weight: 600;
            font-size: 16px;
        }

        .result-success {
            color: #ef4444;
        }

        .result-fail {
            color: #000;
        }

        .time-cell {
            font-weight: 500;
        }

        /* ÎÇ†Ïßú Í∑∏Î£π */
        .date-group {
            margin-bottom: 40px;
        }

        .date-group-header {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        /* TEXT Î¶¨Ïä§Ìä∏ */
        .text-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .text-item {
            padding: 15px;
            background: white;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .text-item:hover {
            background: #f5f5f5;
        }

        .text-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .text-item-title {
            font-weight: 600;
            font-size: 16px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
        }

        .text-item-date {
            font-size: 13px;
            color: #666;
        }

        /* CHECKLIST */
        .checklist-group {
            margin-bottom: 30px;
        }

        .checklist-date {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
        }

        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checklist-item {
            padding: 12px;
            background: white;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checklist-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .checklist-checkbox.checked {
            background: #000;
        }

        .checklist-checkbox.checked::after {
            content: '‚úì';
            font-weight: 700;
            font-size: 14px;
            color: white;
        }

        .checklist-todo {
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Í∑∏ÎûòÌîÑ Ïª®ÌÖåÏù¥ÎÑà */
        .graph-container {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
        }

        .view-toggle {
            display: none;
            gap: 5px;
            flex-shrink: 0;
            width: 100%;
        }

        .view-toggle.active {
            display: flex;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: 1px solid #000;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
            flex: 1;
        }

        .toggle-btn:hover {
            background: #f5f5f5;
        }

        .toggle-btn.active {
            background: #000;
            color: #fff;
        }

        .empty-cell {
            border: none;
        }

        /* Îã¨Î†• Ïä§ÌÉÄÏùº */
        .calendar-year {
            margin-bottom: 40px;
        }

        .calendar-year-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000;
        }

        .calendar-months {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .calendar-month {
            border: 1px solid #e0e0e0;
            padding: 10px;
            background: #fafafa;
        }

        .calendar-month-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-weekday {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            padding: 4px 0;
            color: #666;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: white;
            border: 1px solid #f0f0f0;
        }

        .calendar-day.empty {
            background: transparent;
            border: none;
        }

        .calendar-day.has-data-success {
            background: #ef4444;
            color: white;
            font-weight: 600;
        }

        .calendar-day.has-data-fail {
            background: #000;
            color: white;
            font-weight: 600;
        }

        /* Ï£ºÍ∞Ñ Î∑∞ Ïä§ÌÉÄÏùº */
        .weekly-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
        }

        .weekly-nav-btn {
            padding: 6px 14px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .weekly-nav-btn:hover {
            background: #333;
            color: white;
            border-color: #333;
        }

        .weekly-title {
            font-size: 16px;
            font-weight: 600;
        }

        .weekly-title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .week-date-picker {
            padding: 4px 8px;
            border: 1px solid #ccc;
            font-size: 13px;
            cursor: pointer;
        }

        .weekly-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .weekly-day {
            border: 1px solid #e0e0e0;
            background: white;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .weekly-day-header {
            padding: 10px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .weekly-day-name {
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }

        .weekly-day-num {
            font-size: 16px;
            font-weight: 700;
        }

        .weekly-day-content {
            padding: 10px;
            flex: 1;
            overflow-y: auto;
        }

        .weekly-todo-item {
            padding: 8px;
            margin-bottom: 6px;
            background: #f5f5f5;
            font-size: 13px;
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .weekly-todo-item.completed {
            background: #f5f5f5;
        }

        .weekly-todo-item.incomplete {
            background: #f5f5f5;
        }

        .weekly-todo-status {
            font-weight: 700;
            flex-shrink: 0;
        }

        .weekly-todo-item.completed .weekly-todo-status {
            color: #ef4444;
        }

        .weekly-todo-item.incomplete .weekly-todo-status {
            color: #000;
        }

        .weekly-todo-text {
            flex: 1;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .weekly-empty {
            color: #ccc;
            text-align: center;
            padding: 20px;
        }

        .weekly-has-data {
            background: white;
        }

        /* TEXT Ï£ºÍ∞Ñ Î∑∞ Ïä§ÌÉÄÏùº */
        .text-weekly-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f5f5f5;
            font-size: 13px;
        }

        .text-weekly-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .text-weekly-text {
            color: #666;
            line-height: 1.4;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            width: 98%;
            max-width: 2000px;
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #ddd;
            background: #fafafa;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
            padding: 0;
            width: 28px;
            height: 28px;
        }

        .modal-close:hover {
            color: #333;
        }

        /* ÎåìÍ∏Ä Î™®Îã¨ */
        .comment-modal-content {
            max-width: 650px;
        }

        .comment-content {
            max-height: 450px;
            overflow-y: auto;
            padding: 16px;
        }

        .comment-input-area {
            padding: 12px 16px;
            border-top: 1px solid #ddd;
            background: #fafafa;
        }

        .comment-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            resize: vertical;
            min-height: 50px;
            font-size: 12px;
            font-family: Arial, sans-serif;
        }

        .comment-textarea:focus {
            outline: none;
            border-color: #999;
        }

        .comment-submit-area {
            margin-top: 8px;
            text-align: right;
        }

        .comment-submit-btn {
            padding: 6px 16px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }

        .comment-submit-btn:hover {
            background: #000;
        }

        /* ========== NOTIFICATION SYSTEM ========== */

        /* ÏïåÎ¶º Î≤® ÏïÑÏù¥ÏΩò */
        .notification-bell {
            position: relative;
            padding: 6px 14px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .notification-bell:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        /* ÏùΩÏßÄ ÏïäÏùÄ ÏïåÎ¶º Î∞∞ÏßÄ */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ff0000;
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º Ïª®ÌÖåÏù¥ÎÑà */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        /* ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º */
        .toast-notification {
            background: white;
            border: 1px solid #ddd;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
            cursor: pointer;
        }

        .toast-notification.comment {
            border-left-color: #2196F3;
        }

        .toast-notification.reply {
            border-left-color: #9C27B0;
        }

        .toast-notification.like {
            border-left-color: #ff4081;
        }

        .toast-notification.friend_request {
            border-left-color: #10b981;
        }

        .toast-notification.friend_accept {
            border-left-color: #3b82f6;
        }

        .toast-notification.friend_reject {
            border-left-color: #ef4444;
        }

        .toast-notification:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .toast-message {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .toast-time {
            font-size: 10px;
            color: #999;
            margin-top: 5px;
        }

        /* ÏïåÎ¶º Î™©Î°ù Î™®Îã¨ */
        .notification-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .notification-modal.active {
            display: flex;
        }

        .notification-modal-content {
            background: white;
            width: 90%;
            max-width: 550px;
            max-height: 75vh;
            overflow-y: auto;
            padding: 0;
            position: relative;
            border: 1px solid #ccc;
        }

        .notification-modal-header {
            padding: 14px 16px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #fafafa;
            z-index: 1;
        }

        .notification-modal-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .notification-modal-close {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 26px;
            height: 26px;
            line-height: 1;
        }

        .notification-modal-close:hover {
            color: #333;
        }

        .mark-all-read-btn {
            padding: 4px 10px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
        }

        .mark-all-read-btn:hover {
            background: #000;
        }

        .mark-all-read-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .notification-list {
            padding: 0;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: #f5f5f5;
        }

        .notification-item.unread {
            background: #f0f8ff;
        }

        .notification-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .notification-item-type {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 2px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .notification-item-type.comment {
            background: #e8f4fd;
            color: #1976d2;
        }

        .notification-item-type.reply {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .notification-item-type.like {
            background: #fdeef3;
            color: #c2185b;
        }

        .notification-item-type.friend_request {
            background: #d1fae5;
            color: #065f46;
        }

        .notification-item-type.friend_accept {
            background: #dbeafe;
            color: #1e40af;
        }

        .notification-item-type.friend_reject {
            background: #fee2e2;
            color: #991b1b;
        }

        .notification-item-time {
            font-size: 10px;
            color: #999;
        }

        .notification-item-content {
            font-size: 12px;
            color: #333;
            line-height: 1.4;
        }

        .notification-item-sender {
            font-weight: 600;
            color: #555;
        }

        .notification-empty {
            padding: 50px 20px;
            text-align: center;
            color: #999;
            font-size: 12px;
        }
    </style>
</head>
<body>
<!-- Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ ÏÑπÏÖò -->
<div id="loginSection" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;">
    <div class="simple-auth-container">
        <div class="simple-auth-box">
            <div style="text-align: left; margin-bottom: 10px;">
                <a href="#" onclick="showMainSection(); return false;" style="color: #666; text-decoration: none; font-size: 13px;" data-lang-ko="‚Üê ÌôàÏúºÎ°ú" data-lang-en="‚Üê Back to Home">‚Üê Back to Home</a>
            </div>
            <h2 style="text-align: center; margin-bottom: 30px; font-size: 20px; font-weight: 600;" data-lang-ko="Î°úÍ∑∏Ïù∏" data-lang-en="Sign In">Sign In</h2>
            <div id="loginError" style="color: red; margin-bottom: 10px; text-align: center; font-size: 13px;"></div>
            <form id="loginForm">
                <table style="margin: 0 auto; border-collapse: collapse;">
                    <tr>
                        <td style="text-align: right; padding: 5px 10px 5px 0; font-size: 14px;" data-lang-ko="Ïù¥Î©îÏùº:" data-lang-en="Email:">Email:</td>
                        <td style="padding: 5px 0;"><input type="email" id="email" required style="padding: 5px; width: 200px; border: 1px solid #999; font-size: 14px;"></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding: 5px 10px 5px 0; font-size: 14px;" data-lang-ko="ÎπÑÎ∞ÄÎ≤àÌò∏:" data-lang-en="Password:">Password:</td>
                        <td style="padding: 5px 0;"><input type="password" id="password" required style="padding: 5px; width: 200px; border: 1px solid #999; font-size: 14px;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center; padding-top: 15px;">
                            <button type="submit" style="padding: 6px 20px; border: 1px solid #999; background: #f0f0f0; cursor: pointer; font-size: 14px;" data-lang-ko="Î°úÍ∑∏Ïù∏" data-lang-en="Sign In">Sign In</button>
                        </td>
                    </tr>
                </table>
            </form>
            <div style="text-align: center; margin-top: 20px; font-size: 12px;">
                <span data-lang-ko="Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî?" data-lang-en="New account?">New account?</span> <a href="#" id="showSignup" style="color: #0066cc; text-decoration: underline;" data-lang-ko="ÌöåÏõêÍ∞ÄÏûÖ" data-lang-en="Sign Up">Sign Up</a>
            </div>
        </div>
    </div>
</div>

<!-- ÌöåÏõêÍ∞ÄÏûÖ ÏÑπÏÖò -->
<div id="signupSection" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;">
    <div class="simple-auth-container">
        <div class="simple-auth-box">
            <div style="text-align: left; margin-bottom: 10px;">
                <a href="#" onclick="showMainSection(); return false;" style="color: #666; text-decoration: none; font-size: 13px;" data-lang-ko="‚Üê ÌôàÏúºÎ°ú" data-lang-en="‚Üê Back to Home">‚Üê Back to Home</a>
            </div>
            <h2 style="text-align: center; margin-bottom: 30px; font-size: 20px; font-weight: 600;" data-lang-ko="ÌöåÏõêÍ∞ÄÏûÖ" data-lang-en="Sign Up">Sign Up</h2>
            <div id="signupError" style="color: red; margin-bottom: 10px; text-align: center; font-size: 13px;"></div>
            <form id="signupForm">
                <table style="margin: 0 auto; border-collapse: collapse;">
                    <tr>
                        <td style="text-align: right; padding: 5px 10px 5px 0; font-size: 14px;" data-lang-ko="ÏÇ¨Ïö©ÏûêÎ™Ö:" data-lang-en="Username:">Username:</td>
                        <td style="padding: 5px 0;"><input type="text" id="signupUsername" required style="padding: 5px; width: 200px; border: 1px solid #999; font-size: 14px;"></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding: 5px 10px 5px 0; font-size: 14px;" data-lang-ko="Ïù¥Î©îÏùº:" data-lang-en="Email:">Email:</td>
                        <td style="padding: 5px 0;"><input type="email" id="signupEmail" required style="padding: 5px; width: 200px; border: 1px solid #999; font-size: 14px;"></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding: 5px 10px 5px 0; font-size: 14px;" data-lang-ko="ÎπÑÎ∞ÄÎ≤àÌò∏:" data-lang-en="Password:">Password:</td>
                        <td style="padding: 5px 0;"><input type="password" id="signupPassword" required style="padding: 5px; width: 200px; border: 1px solid #999; font-size: 14px;"></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding: 5px 10px 5px 0; font-size: 14px;" data-lang-ko="ÏßÅÌï®:" data-lang-en="Title:">Title:</td>
                        <td style="padding: 5px 0;"><input type="text" id="signupTitle" style="padding: 5px; width: 200px; border: 1px solid #999; font-size: 14px;"></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding: 5px 10px 5px 0; font-size: 14px;" data-lang-ko="ÏÑ§Î™Ö:" data-lang-en="Description:">Description:</td>
                        <td style="padding: 5px 0;"><input type="text" id="signupDescription" style="padding: 5px; width: 200px; border: 1px solid #999; font-size: 14px;"></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding: 5px 10px 5px 0; font-size: 14px;" data-lang-ko="ÏÉùÎÖÑ:" data-lang-en="Birth Year:">Birth Year:</td>
                        <td style="padding: 5px 0;"><input type="number" id="signupBirthYear" placeholder="YYYY" style="padding: 5px; width: 200px; border: 1px solid #999; font-size: 14px;"></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding: 5px 10px 5px 0; font-size: 14px;" data-lang-ko="ÏÉùÏõî:" data-lang-en="Birth Month:">Birth Month:</td>
                        <td style="padding: 5px 0;"><input type="number" id="signupBirthMonth" placeholder="MM" min="1" max="12" style="padding: 5px; width: 200px; border: 1px solid #999; font-size: 14px;"></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding: 5px 10px 5px 0; font-size: 14px;" data-lang-ko="ÏÉùÏùº:" data-lang-en="Birth Day:">Birth Day:</td>
                        <td style="padding: 5px 0;"><input type="number" id="signupBirthDay" placeholder="DD" min="1" max="31" style="padding: 5px; width: 200px; border: 1px solid #999; font-size: 14px;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center; padding-top: 15px;">
                            <button type="submit" style="padding: 6px 20px; border: 1px solid #999; background: #f0f0f0; cursor: pointer; font-size: 14px; margin-right: 10px;" data-lang-ko="ÌöåÏõêÍ∞ÄÏûÖ" data-lang-en="Sign Up">Sign Up</button>
                            <button type="button" id="cancelSignup" style="padding: 6px 20px; border: 1px solid #999; background: #f0f0f0; cursor: pointer; font-size: 14px;" data-lang-ko="Ï∑®ÏÜå" data-lang-en="Cancel">Cancel</button>
                        </td>
                    </tr>
                </table>
            </form>
            <div style="text-align: center; margin-top: 20px; font-size: 12px;">
                <span data-lang-ko="Ïù¥ÎØ∏ Í≥ÑÏ†ïÏù¥ ÏûàÏúºÏã†Í∞ÄÏöî?" data-lang-en="Already have an account?">Already have an account?</span> <a href="#" id="showLogin" style="color: #0066cc; text-decoration: underline;" data-lang-ko="Î°úÍ∑∏Ïù∏" data-lang-en="Sign In">Sign In</a>
            </div>
        </div>
    </div>
</div>

<!-- Î©îÏù∏ ÏÑπÏÖò -->
<div id="mainSection">
    <div class="top-actions" id="topActions">
        <a href="#" class="btn" id="loginBtn">Î°úÍ∑∏Ïù∏</a>
        <a href="#" class="btn btn-primary" id="signupBtn">ÌöåÏõêÍ∞ÄÏûÖ</a>
    </div>

    <div class="header">
        <div class="greeting" data-lang-ko="Í≥µÍ∞ú Ïπ¥ÌÖåÍ≥†Î¶¨" data-lang-en="Public Categories">Í≥µÍ∞ú Ïπ¥ÌÖåÍ≥†Î¶¨</div>
        <div class="subtitle" data-lang-ko="Îã§Î•∏ ÏÇ¨Ïö©ÏûêÎì§Ïù¥ Í≥µÍ∞úÌïú Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî" data-lang-en="Explore categories shared by other users">Îã§Î•∏ ÏÇ¨Ïö©ÏûêÎì§Ïù¥ Í≥µÍ∞úÌïú Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</div>
    </div>

    <div class="categories-grid" id="categoriesGrid">
        <div class="empty-state" data-lang-ko="Í≥µÍ∞ú Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î∂àÎü¨Ïò§Îäî Ï§ë..." data-lang-en="Loading public categories...">Í≥µÍ∞ú Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
    </div>
</div>

<!-- Î†àÏΩîÎìú Ï°∞Ìöå Î™®Îã¨ -->
<div id="recordsModal" class="modal">
    <div class="modal-content" style="max-width: 2000px; width: 98%; max-height: 95vh;">
        <div class="modal-header">
            <div class="modal-title" id="recordsModalTitle" data-lang-ko="Î†àÏΩîÎìú Ï°∞Ìöå" data-lang-en="View Records">Î†àÏΩîÎìú Ï°∞Ìöå</div>
            <button class="modal-close" onclick="closeRecordsModal()">√ó</button>
        </div>
        <div style="padding: 10px 20px; border-bottom: 1px solid #e0e0e0;">
            <div class="view-toggle" id="viewToggle" style="display: flex; gap: 5px;"></div>
        </div>
        <div id="recordsContent" style="max-height: 80vh; overflow-y: auto; padding: 20px;">
            <div class="empty-state" data-lang-ko="Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë..." data-lang-en="Loading data...">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        </div>
    </div>
</div>

<!-- ÎåìÍ∏Ä Î™®Îã¨ -->
<div id="commentModal" class="modal">
    <div class="modal-content comment-modal-content">
        <div class="modal-header">
            <div class="modal-title" id="commentModalTitle">ÎåìÍ∏Ä</div>
            <button class="modal-close" onclick="closeCommentModal()">√ó</button>
        </div>
        <div id="commentContent" class="comment-content">
            <div class="empty-state" data-lang-ko="ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë..." data-lang-en="Loading comments...">ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        </div>
        <div class="comment-input-area">
            <textarea id="commentInput" class="comment-textarea" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
            <div class="comment-submit-area">
                <button onclick="submitComment()" class="comment-submit-btn">
                    <span data-lang-ko="Îì±Î°ù" data-lang-en="Submit">Îì±Î°ù</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/api';
    const TOKEN_KEY = 'accessToken';
    let currentUser = null;
    let currentCategory = null;
    let allRecords = [];
    let currentView = 'table';
    let currentWeekStart = null;
    let currentLang = localStorage.getItem('language') || 'ko'; // 'ko' or 'en'

    // ========== fetchEventSource ÏûêÏ≤¥ Íµ¨ÌòÑ ==========
    window.fetchEventSource = async function(url, options) {
        const {
            onopen,
            onmessage,
            onerror,
            onclose,
            signal,
            headers = {},
            ...fetchOptions
        } = options;

        try {
            const response = await fetch(url, {
                ...fetchOptions,
                headers: headers,
                signal: signal
            });

            if (onopen) {
                await onopen(response);
            }

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();

                if (done) {
                    if (onclose) onclose();
                    break;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n\n');
                buffer = lines.pop() || '';

                for (const eventText of lines) {
                    if (eventText.trim() === '') continue;

                    const event = { event: 'message', data: '' };
                    const eventLines = eventText.split('\n');

                    for (const line of eventLines) {
                        if (line.startsWith('event:')) {
                            event.event = line.substring(6).trim();
                        } else if (line.startsWith('data:')) {
                            if (event.data) event.data += '\n';
                            event.data += line.substring(5).trim();
                        }
                    }

                    if (onmessage && event.data) {
                        try {
                            onmessage(event);
                        } catch (err) {
                            console.error('onmessage ÏóêÎü¨:', err);
                        }
                    }
                }
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('fetchEventSource: Ïó∞Í≤∞Ïù¥ Ï§ëÎã®ÎêòÏóàÏäµÎãàÎã§.');
            } else {
                console.error('fetchEventSource ÏóêÎü¨:', error);
                if (onerror) {
                    onerror(error);
                }
            }
            throw error;
        }
    };

    // ========== ÌÜ†ÌÅ∞ Í¥ÄÎ¶¨ ==========

    function setAccessToken(token) {
        if (token) {
            localStorage.setItem(TOKEN_KEY, token);
        } else {
            localStorage.removeItem(TOKEN_KEY);
        }
    }

    function getAccessToken() {
        return localStorage.getItem(TOKEN_KEY);
    }

    function removeAccessToken() {
        localStorage.removeItem(TOKEN_KEY);
    }

    async function refreshAccessToken() {
        try {
            const response = await fetch(`${API_BASE}/auth/refresh`, {
                method: 'POST',
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                setAccessToken(data.accessToken);
                console.log('‚úÖ Access ÌÜ†ÌÅ∞ Í∞±Ïã† ÏÑ±Í≥µ');
                return data.accessToken;
            } else {
                console.log('‚ùå Refresh ÌÜ†ÌÅ∞ ÎßåÎ£å');
                removeAccessToken();
                return null;
            }
        } catch (error) {
            console.error('ÌÜ†ÌÅ∞ Í∞±Ïã† Ïò§Î•ò:', error);
            removeAccessToken();
            return null;
        }
    }

    async function apiCall(url, options = {}) {
        const fullUrl = url.startsWith('http') ? url : `${API_BASE}${url}`;

        const defaultOptions = {
                ...options.headers
            }
        };

        const token = getAccessToken();
        if (token) {
            defaultOptions.headers['Authorization'] = `Bearer ${token}`;
        }

        const finalOptions = { ...defaultOptions, ...options };
        if (options.headers) {
            finalOptions.headers = { ...defaultOptions.headers, ...options.headers };
        }

        try {
            let response = await fetch(fullUrl, finalOptions);

            if (response.status === 401) {
                console.log('üîÑ ÌÜ†ÌÅ∞ ÎßåÎ£å, Í∞±Ïã† ÏãúÎèÑ...');
                const newToken = await refreshAccessToken();

                if (newToken) {
                    finalOptions.headers['Authorization'] = `Bearer ${newToken}`;
                    response = await fetch(fullUrl, finalOptions);
                } else {
                    throw new Error('LOGIN_REQUIRED');
                }
            }

            return response;
        } catch (error) {
            throw error;
        }
    }

    // Î≤àÏó≠ Îç∞Ïù¥ÌÑ∞
    const translations = {
        'subtitle': { ko: 'Îã§Î•∏ ÏÇ¨Ïö©ÏûêÎì§Ïù¥ Í≥µÍ∞úÌïú Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî', en: 'Explore categories shared by other users' },
        'loading': { ko: 'Í≥µÍ∞ú Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...', en: 'Loading public categories...' },
        'noCategories': { ko: 'Í≥µÍ∞úÎêú Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.', en: 'No public categories available.' },
        'viewRecords': { ko: 'Î†àÏΩîÎìú Î≥¥Í∏∞', en: 'View Records' },
        'graph': { ko: 'Í∑∏ÎûòÌîÑ', en: 'Graph' },
        'table': { ko: 'ÌÖåÏù¥Î∏î', en: 'Table' },
        'calendar': { ko: 'Îã¨Î†•', en: 'Calendar' },
        'list': { ko: 'Î¶¨Ïä§Ìä∏', en: 'List' }
    };

    // Ïñ∏Ïñ¥ Ï†ÑÌôò Ìï®Ïàò
    function toggleLanguage() {
        currentLang = currentLang === 'ko' ? 'en' : 'ko';
        localStorage.setItem('language', currentLang);
        applyLanguage();

        // Î™®Îã¨Ïù¥ Ïó¥Î†§ÏûàÏúºÎ©¥ Î†àÏΩîÎìú Îã§Ïãú ÌëúÏãú (Í∑∏ÎûòÌîÑ Î∞è Î∑∞ ÌÜ†Í∏Ä ÏóÖÎç∞Ïù¥Ìä∏ ÏúÑÌï¥)
        if (currentCategory && allRecords) {
            displayRecords(allRecords, currentCategory);
        }
    }

    // Ïñ∏Ïñ¥ Ï†ÅÏö© Ìï®Ïàò
    function applyLanguage() {
        // Ïñ∏Ïñ¥ ÌÜ†Í∏Ä Î≤ÑÌäº ÌÖçÏä§Ìä∏ Î≥ÄÍ≤Ω
        const langBtn = document.getElementById('languageToggle');
        if (langBtn) {
            langBtn.textContent = currentLang === 'ko' ? 'EN' : 'KO';
        }

        // data-lang ÏÜçÏÑ±Ïù¥ ÏûàÎäî Î™®Îì† ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏
        document.querySelectorAll('[data-lang-ko]').forEach(element => {
            const ko = element.getAttribute('data-lang-ko');
            const en = element.getAttribute('data-lang-en');
            element.textContent = currentLang === 'ko' ? ko : en;
        });
    }


    // ÌéòÏù¥ÏßÄ Î°úÎìú
    window.addEventListener('DOMContentLoaded', async () => {
        await checkAuth();
        await loadPublicCategories();
        applyLanguage();
    });

    // Ïù∏Ï¶ù ÌôïÏù∏
    async function checkAuth() {
        console.log('üîç Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏...');
        const token = getAccessToken();

        // ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏúºÎ©¥ refresh ÏãúÎèÑ
        if (!token) {
            console.log('ÌÜ†ÌÅ∞ ÏóÜÏùå, refresh ÏãúÎèÑ...');
            const newToken = await refreshAccessToken();
            if (newToken) {
                console.log('‚úÖ Refresh ÏÑ±Í≥µ');
                await loadCurrentUser();
                return;
            }
        } else {
            // ÌÜ†ÌÅ∞Ïù¥ ÏûàÏúºÎ©¥ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            try {
                const response = await apiCall('/user');
                if (response.ok) {
                    console.log('‚úÖ ÌÜ†ÌÅ∞ Ïú†Ìö®');
                    await loadCurrentUser();
                    return;
                }
            } catch (error) {
                if (error.message === 'LOGIN_REQUIRED') {
                    console.log('‚ùå ÌÜ†ÌÅ∞ ÎßåÎ£å');
                } else {
                    console.error('Ïù∏Ï¶ù ÌôïÏù∏ Ïò§Î•ò:', error);
                }
            }
        }

        console.log('üìù Î°úÍ∑∏ÏïÑÏõÉ ÏÉÅÌÉú');
        updateAuthUI(false);
    }

    // ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú
    async function loadCurrentUser() {
        try {
            const response = await apiCall('/user');

            if (response.ok) {
                currentUser = await response.json();
                console.log('‚úÖ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥:', currentUser);
                updateAuthUI(true);
            } else {
                console.error('‚ùå ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®');
                updateAuthUI(false);
            }
        } catch (error) {
            console.error('‚ùå ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ï§ë Ïò§Î•ò:', error);
            if (error.message === 'LOGIN_REQUIRED') {
                removeAccessToken();
                updateAuthUI(false);
            }
        }
    }

    // Ïù∏Ï¶ù UI ÏóÖÎç∞Ïù¥Ìä∏
    async function updateAuthUI(isLoggedIn) {
        const topActions = document.getElementById('topActions');
        if (isLoggedIn) {
            topActions.innerHTML = `
                <button class="language-toggle" id="languageToggle" onclick="toggleLanguage()">EN</button>
                <a href="manage.html" class="btn" data-lang-ko="ÎÇ¥ Í¥ÄÎ¶¨" data-lang-en="My Page">ÎÇ¥ Í¥ÄÎ¶¨</a>
                <a href="insert.html" class="btn" data-lang-ko="Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•" data-lang-en="Insert Data">Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•</a>
                <a href="friend.html" class="btn" data-lang-ko="ÏπúÍµ¨ Í¥ÄÎ¶¨" data-lang-en="Friends">ÏπúÍµ¨ Í¥ÄÎ¶¨</a>
                <button class="notification-bell" id="notificationBell" onclick="toggleNotificationModal()">
                    üîî
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
                <button class="btn btn-primary" id="logoutBtn" data-lang-ko="Î°úÍ∑∏ÏïÑÏõÉ" data-lang-en="Logout">Î°úÍ∑∏ÏïÑÏõÉ</button>
            `;
            document.getElementById('logoutBtn').addEventListener('click', logout);
            applyLanguage();

            // DOM ÏóÖÎç∞Ïù¥Ìä∏ ÎåÄÍ∏∞ (Ï§ëÏöî!)
            await new Promise(resolve => setTimeout(resolve, 0));

            // ‚≠ê Ï§ëÏöî: ÏàúÏÑú Î≥ÄÍ≤Ω - Î®ºÏ†Ä ÏïåÎ¶º Î°úÎìú, Í∑∏ Îã§Ïùå SSE Ïó∞Í≤∞
            await loadUnreadNotifications();
            connectSSE();
        } else {
            topActions.innerHTML = `
                <button class="language-toggle" id="languageToggle" onclick="toggleLanguage()">EN</button>
                <a href="#" class="btn" id="loginBtn" data-lang-ko="Î°úÍ∑∏Ïù∏" data-lang-en="Sign In">Î°úÍ∑∏Ïù∏</a>
                <a href="#" class="btn btn-primary" id="signupBtn" data-lang-ko="ÌöåÏõêÍ∞ÄÏûÖ" data-lang-en="Sign Up">ÌöåÏõêÍ∞ÄÏûÖ</a>
            `;
            document.getElementById('loginBtn').addEventListener('click', (e) => {
                e.preventDefault();
                showLoginSection();
            });
            applyLanguage();
            document.getElementById('signupBtn').addEventListener('click', (e) => {
                e.preventDefault();
                showSignupSection();
            });
        }
    }

    // Î°úÍ∑∏Ïù∏
    async function login(e) {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                window.location.href = 'manage.html';
            } else {
                showError('loginError', 'Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        } catch (error) {
            showError('loginError', 'Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
    }

    // ÌöåÏõêÍ∞ÄÏûÖ
    async function signup(e) {
        e.preventDefault();

        const signupData = {
            username: document.getElementById('signupUsername').value,
            email: document.getElementById('signupEmail').value,
            password: document.getElementById('signupPassword').value,
            title: document.getElementById('signupTitle').value || '',
            description: document.getElementById('signupDescription').value || '',
            birthYear: parseInt(document.getElementById('signupBirthYear').value) || null,
            birthMonth: parseInt(document.getElementById('signupBirthMonth').value) || null,
            birthDay: parseInt(document.getElementById('signupBirthDay').value) || null
        };

        try {
            const response = await fetch(`${API_BASE}/auth/signup`, {
                method: 'POST',
                body: JSON.stringify(signupData)
            });

            if (response.ok) {
                // ÌöåÏõêÍ∞ÄÏûÖ ÌõÑ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú
                document.getElementById('signupSection').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';
                showError('loginError', 'ÌöåÏõêÍ∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
            } else {
                showError('signupError', 'ÌöåÏõêÍ∞ÄÏûÖÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        } catch (error) {
            showError('signupError', 'ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
    }

    // Î°úÍ∑∏ÏïÑÏõÉ
    async function logout() {
        try {
            await fetch(`${API_BASE}/auth/logout`, {
                method: 'POST',
                credentials: 'include'
            });
        } catch (error) {
            console.error('Î°úÍ∑∏ÏïÑÏõÉ Ïò§Î•ò:', error);
        } finally {
            removeAccessToken();
            currentUser = null;
            location.reload();
        }
    }

    // Í≥µÍ∞ú Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú
    async function loadPublicCategories() {
        try {
            const response = await apiCall('/category/public');

            if (response.ok) {
                const data = await response.json();

                // ÏÉàÎ°úÏö¥ Íµ¨Ï°∞: [{email, categories: [...]}, ...]
                // Î™®Îì† Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÌèâÌÉÑÌôîÌïòÍ≥† email Ï†ïÎ≥¥ Ï∂îÍ∞Ä
                const allCategories = [];
                data.forEach(userGroup => {
                    const email = userGroup.email;
                    userGroup.categories.forEach(category => {
                        allCategories.push({
                            ...category,
                            email: email
                        });
                    });
                });

                displayCategories(allCategories);
            } else {
                document.getElementById('categoriesGrid').innerHTML =
                    '<div class="empty-state">Í≥µÍ∞ú Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        } catch (error) {
            document.getElementById('categoriesGrid').innerHTML =
                '<div class="empty-state">Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</div>';
        }
    }

    // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌëúÏãú
    function displayCategories(categories) {
        const grid = document.getElementById('categoriesGrid');

        if (!categories || categories.length === 0) {
            grid.innerHTML = '<div class="empty-state" data-lang-ko="Í≥µÍ∞úÎêú Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§." data-lang-en="No public categories available.">Í≥µÍ∞úÎêú Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            applyLanguage();
            return;
        }

        grid.innerHTML = categories.map(category => {
            const id = category.categoryId || category.id; // fallback Ï∂îÍ∞Ä
            const title = category.title;
            const recordType = category.recordType;
            const email = category.email;

            // idÍ∞Ä ÏóÜÏúºÎ©¥ Í±¥ÎÑàÎõ∞Í∏∞
            if (!id) {
                return '';
            }

            return `
                <div class="category-card" data-id="${id}" data-type="${recordType}" data-author-email="${email}">
                    <div class="category-title">${title}</div>
                    <div class="category-type">${recordType}</div>
                    <div class="category-meta"><span data-lang-ko="ÏûëÏÑ±Ïûê" data-lang-en="Author">ÏûëÏÑ±Ïûê</span>: ${email}</div>
                    <div class="category-actions">
                        <button class="category-action-btn like-btn" data-category-id="${id}" onclick="toggleLike(event, '${id}')" style="min-width: 60px;">
                            <span class="like-icon" style="display: inline-block;">‚ô°</span>
                            <span class="like-count" id="like-count-${id}" style="display: inline-block;">0</span>
                        </button>
                        <button class="category-action-btn comment-btn" onclick="openCommentModal(event, '${id}', '${title.replace(/'/g, "\\'")}')">
                            <span data-lang-ko="ÎåìÍ∏Ä" data-lang-en="Comments">ÎåìÍ∏Ä</span>
                        </button>
                        ${currentUser && currentUser.email !== email ? `
                        <button class="category-action-btn" onclick="sendFriendRequest(event, '${email}')" style="background: #f0f8ff; border-color: #3b82f6; flex: 0 1 auto;">
                            <span data-lang-ko="ÏπúÍµ¨ ÏöîÏ≤≠" data-lang-en="Add Friend">ÏπúÍµ¨ ÏöîÏ≤≠</span>
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');

        // Ïñ∏Ïñ¥ Ï†ÅÏö©
        applyLanguage();

        // Ï¢ãÏïÑÏöî Í∞úÏàò Î∞è ÏÉÅÌÉú Î°úÎìú
        categories.forEach(category => {
            const categoryId = category.categoryId || category.id;
            if (categoryId) {
                loadLikeCount(categoryId);
                if (currentUser) {
                    loadLikeStatus(categoryId);
                }
            }
        });

        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        grid.querySelectorAll('.category-card').forEach(card => {
            card.addEventListener('click', () => {
                grid.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');

                currentCategory = {
                    id: card.getAttribute('data-id'),
                    type: card.getAttribute('data-type'),
                    title: card.querySelector('.category-title').textContent
                };

                openRecordsModal(currentCategory);
            });
        });
    }

    // Î†àÏΩîÎìú Î™®Îã¨ Ïó¥Í∏∞
    function openRecordsModal(category) {
        const modal = document.getElementById('recordsModal');
        const modalTitle = document.getElementById('recordsModalTitle');

        modalTitle.textContent = `${category.title} - ${category.type}`;
        modal.classList.add('active');

        loadRecords(category);
    }

    // Î†àÏΩîÎìú Î™®Îã¨ Îã´Í∏∞
    function closeRecordsModal() {
        const modal = document.getElementById('recordsModal');
        modal.classList.remove('active');
        currentWeekStart = null; // Ï£ºÍ∞Ñ Î∑∞ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
    }

    // Î†àÏΩîÎìú Î°úÎìú
    async function loadRecords(category) {
        const recordsContent = document.getElementById('recordsContent');

        recordsContent.innerHTML = '<div class="empty-state" data-lang-ko="Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë..." data-lang-en="Loading data...">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
        applyLanguage();

        // ÌÉÄÏûÖÎ≥Ñ Í∏∞Î≥∏ Î∑∞ ÏÑ§Ï†ï
        if (category.type === 'CHECK') {
            currentView = 'table';
        } else if (category.type === 'TIME' || category.type === 'NUMBER') {
            currentView = 'graph';
        } else if (category.type === 'TEXT' || category.type === 'CHECKLIST') {
            currentView = 'weekly';
        }

        try {
            let endpoint = '';
            switch (category.type) {
                case 'CHECK':
                    endpoint = `${API_BASE}/check/all?categoryId=${category.id}`;
                    break;
                case 'TEXT':
                    endpoint = `${API_BASE}/text/all?categoryId=${category.id}`;
                    break;
                case 'TIME':
                    endpoint = `${API_BASE}/time/all?categoryId=${category.id}`;
                    break;
                case 'NUMBER':
                    endpoint = `${API_BASE}/number/all?categoryId=${category.id}`;
                    break;
                case 'CHECKLIST':
                    endpoint = `${API_BASE}/check-list/all?categoryId=${category.id}`;
                    break;
            }

            const response = await fetch(endpoint, { credentials: 'include' });

            if (response.ok) {
                const contentType = response.headers.get('content-type');

                if (contentType && contentType.includes('application/json')) {
                    allRecords = await response.json();
                    displayRecords(allRecords, category);
                } else {
                    recordsContent.innerHTML = `
                        <div class="empty-state">
                            <p>Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò Îç∞Ïù¥ÌÑ∞Î•º Ï°∞ÌöåÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                            <p style="font-size: 14px; color: #666; margin-top: 10px;">
                                Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïòÍ±∞ÎÇò Ï†ëÍ∑ºÏù¥ Ï†úÌïúÎêú Ïπ¥ÌÖåÍ≥†Î¶¨Ïùº Ïàò ÏûàÏäµÎãàÎã§.
                            </p>
                        </div>
                    `;
                }
            } else {
                recordsContent.innerHTML = `
                    <div class="empty-state">
                        <p>Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                        <p style="font-size: 14px; color: #666;">ÏÉÅÌÉú ÏΩîÎìú: ${response.status}</p>
                    </div>
                `;
            }
        } catch (error) {
            recordsContent.innerHTML = `<div class="empty-state">Ïò§Î•ò: ${error.message}</div>`;
        }
    }

    // Î†àÏΩîÎìú ÌëúÏãú (ÌÉÄÏûÖÎ≥ÑÎ°ú Îã§Î•∏ Î†àÏù¥ÏïÑÏõÉ)
    function displayRecords(records, category) {
        const recordsContent = document.getElementById('recordsContent');
        const viewToggle = document.getElementById('viewToggle');

        if (!records || records.length === 0) {
            viewToggle.style.display = 'none';
            recordsContent.innerHTML = '<div class="empty-state" data-lang-ko="Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§." data-lang-en="No data available.">Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            applyLanguage();
            return;
        }

        viewToggle.style.display = 'flex';

        // ÌÉÄÏûÖÎ≥Ñ Î≤ÑÌäº Íµ¨ÏÑ±
        if (category.type === 'CHECK') {
            viewToggle.innerHTML = `
                <button class="toggle-btn ${currentView === 'table' ? 'active' : ''}" onclick="switchView('table')" data-lang-ko="ÌÖåÏù¥Î∏î" data-lang-en="Table">ÌÖåÏù¥Î∏î</button>
                <button class="toggle-btn ${currentView === 'calendar' ? 'active' : ''}" onclick="switchView('calendar')" data-lang-ko="Îã¨Î†•" data-lang-en="Calendar">Îã¨Î†•</button>
            `;
        } else if (category.type === 'TIME') {
            viewToggle.innerHTML = `
                <button class="toggle-btn ${currentView === 'graph' ? 'active' : ''}" onclick="switchView('graph')" data-lang-ko="Í∑∏ÎûòÌîÑ" data-lang-en="Graph">Í∑∏ÎûòÌîÑ</button>
                <button class="toggle-btn ${currentView === 'table' ? 'active' : ''}" onclick="switchView('table')" data-lang-ko="ÌÖåÏù¥Î∏î" data-lang-en="Table">ÌÖåÏù¥Î∏î</button>
            `;
        } else if (category.type === 'NUMBER') {
            viewToggle.innerHTML = `
                <button class="toggle-btn ${currentView === 'graph' ? 'active' : ''}" onclick="switchView('graph')" data-lang-ko="Í∑∏ÎûòÌîÑ" data-lang-en="Graph">Í∑∏ÎûòÌîÑ</button>
                <button class="toggle-btn ${currentView === 'table' ? 'active' : ''}" onclick="switchView('table')" data-lang-ko="ÌÖåÏù¥Î∏î" data-lang-en="Table">ÌÖåÏù¥Î∏î</button>
            `;
        } else if (category.type === 'TEXT') {
            viewToggle.innerHTML = `
                <button class="toggle-btn ${currentView === 'weekly' ? 'active' : ''}" onclick="switchView('weekly')" data-lang-ko="Ï£ºÍ∞Ñ" data-lang-en="Weekly">Ï£ºÍ∞Ñ</button>
                <button class="toggle-btn ${currentView === 'list' ? 'active' : ''}" onclick="switchView('list')" data-lang-ko="Î¶¨Ïä§Ìä∏" data-lang-en="List">Î¶¨Ïä§Ìä∏</button>
            `;
        } else if (category.type === 'CHECKLIST') {
            viewToggle.innerHTML = `
                <button class="toggle-btn ${currentView === 'weekly' ? 'active' : ''}" onclick="switchView('weekly')" data-lang-ko="Ï£ºÍ∞Ñ" data-lang-en="Weekly">Ï£ºÍ∞Ñ</button>
                <button class="toggle-btn ${currentView === 'list' ? 'active' : ''}" onclick="switchView('list')" data-lang-ko="Î¶¨Ïä§Ìä∏" data-lang-en="List">Î¶¨Ïä§Ìä∏</button>
            `;
        }

        applyLanguage();
        renderCurrentView(records, category);
    }

    // Î∑∞ Ï†ÑÌôò
    function switchView(view) {
        currentView = view;
        if (allRecords && currentCategory) {
            displayRecords(allRecords, currentCategory);
        }
    }

    // ÌòÑÏû¨ Î∑∞ Î†åÎçîÎßÅ
    function renderCurrentView(records, category) {
        const content = document.getElementById('recordsContent');

        if (category.type === 'CHECK') {
            if (currentView === 'table') {
                displayCheckTable(records, content);
            } else {
                displayCheckCalendar(records, content);
            }
        } else if (category.type === 'TIME') {
            if (currentView === 'graph') {
                displayTimeGraph(records, content);
            } else {
                displayTimeTable(records, content);
            }
        } else if (category.type === 'NUMBER') {
            if (currentView === 'graph') {
                displayNumberGraph(records, content);
            } else {
                displayNumberTable(records, content);
            }
        } else if (category.type === 'TEXT') {
            if (currentView === 'weekly') {
                displayTextWeekly(records, content);
            } else {
                displayTextList(records, content);
            }
        } else if (category.type === 'CHECKLIST') {
            if (currentView === 'weekly') {
                displayChecklistWeekly(records, content);
            } else {
                displayChecklistList(records, content);
            }
        }
    }

    // CHECK ÌÖåÏù¥Î∏î Î∑∞
    function displayCheckTable(records, container) {
        const recordMap = {};
        records.forEach(record => {
            if (record.date) recordMap[record.date] = record;
        });

        const sortedDates = Object.keys(recordMap).sort((a, b) => a.localeCompare(b));

        let html = '<table class="check-table">';
        for (let i = 0; i < sortedDates.length; i += 10) {
            const chunk = sortedDates.slice(i, i + 10);

            html += '<tr>';
            chunk.forEach(date => {
                html += `<td class="date-cell">${date}</td>`;
            });
            for (let j = chunk.length; j < 10; j++) {
                html += '<td class="empty-cell"></td>';
            }
            html += '</tr><tr>';

            chunk.forEach(date => {
                const record = recordMap[date];
                const symbol = record.success ? 'O' : 'X';
                const resultClass = record.success ? 'result-success' : 'result-fail';
                html += `<td class="result-cell ${resultClass}">${symbol}</td>`;
            });
            for (let j = chunk.length; j < 10; j++) {
                html += '<td class="empty-cell"></td>';
            }
            html += '</tr>';
        }
        html += '</table>';
        container.innerHTML = html;
    }

    // CHECK Îã¨Î†• Î∑∞
    function displayCheckCalendar(records, container) {
        // ÎÇ†ÏßúÎ≥ÑÎ°ú Î†àÏΩîÎìú ÎßµÌïë
        const recordsByDate = {};
        records.forEach(record => {
            if (record.date) {
                recordsByDate[record.date] = record;
            }
        });

        // Ïó∞ÎèÑÎ≥ÑÎ°ú Í∑∏Î£πÌôî
        const yearMap = {};
        Object.keys(recordsByDate).forEach(date => {
            const year = date.split('-')[0];
            if (!yearMap[year]) {
                yearMap[year] = {};
            }
            const month = date.split('-')[1];
            if (!yearMap[year][month]) {
                yearMap[year][month] = {};
            }
            yearMap[year][month][date] = recordsByDate[date];
        });

        // ÎÖÑÎèÑ Ï†ïÎ†¨ (Ïò§ÎûòÎêú Ïàú)
        const sortedYears = Object.keys(yearMap).sort((a, b) => a.localeCompare(b));

        if (sortedYears.length === 0) {
            container.innerHTML = '<div class="empty-state" data-lang-ko="Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§." data-lang-en="No data available.">Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            applyLanguage();
            return;
        }

        let html = '';

        sortedYears.forEach(year => {
            html += `<div class="calendar-year">`;
            html += `<div class="calendar-year-title" data-lang-ko="${year}ÎÖÑ" data-lang-en="${year}">${currentLang === 'ko' ? year + 'ÎÖÑ' : year}</div>`;

            // ÏõîÎ≥Ñ Îã¨Î†• (1~12Ïõî)
            html += `<div class="calendar-months">`;
            for (let month = 1; month <= 12; month++) {
                const monthStr = String(month).padStart(2, '0');
                const monthData = yearMap[year][monthStr] || {};

                html += generateCheckMonthCalendar(year, month, monthData);
            }
            html += `</div>`;
            html += `</div>`;
        });

        container.innerHTML = html;
    }

    // CHECK ÏõîÎ≥Ñ Îã¨Î†• ÏÉùÏÑ±
    function generateCheckMonthCalendar(year, month, monthData) {
        const monthStr = String(month).padStart(2, '0');
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();

        const monthNameKo = `${month}Ïõî`;
        const monthNameEn = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][month - 1];

        let html = `<div class="calendar-month">`;
        html += `<div class="calendar-month-title" data-lang-ko="${monthNameKo}" data-lang-en="${monthNameEn}">${currentLang === 'ko' ? monthNameKo : monthNameEn}</div>`;
        html += `<div class="calendar-grid">`;

        // ÏöîÏùº Ìó§Îçî
        const weekDaysKo = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
        const weekDaysEn = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        for (let i = 0; i < 7; i++) {
            html += `<div class="calendar-weekday" data-lang-ko="${weekDaysKo[i]}" data-lang-en="${weekDaysEn[i]}">${currentLang === 'ko' ? weekDaysKo[i] : weekDaysEn[i]}</div>`;
        }

        // Ï≤´ Ï£º Îπà Ïπ∏
        for (let i = 0; i < startDayOfWeek; i++) {
            html += `<div class="calendar-day empty"></div>`;
        }

        // ÎÇ†ÏßúÎì§
        for (let day = 1; day <= daysInMonth; day++) {
            const dayStr = String(day).padStart(2, '0');
            const dateStr = `${year}-${monthStr}-${dayStr}`;
            const record = monthData[dateStr];

            if (record) {
                const className = record.success ? 'has-data-success' : 'has-data-fail';
                html += `<div class="calendar-day ${className}">${day}</div>`;
            } else {
                html += `<div class="calendar-day">${day}</div>`;
            }
        }

        html += `</div>`;
        html += `</div>`;

        return html;
    }

    // TIME Í∑∏ÎûòÌîÑ Î∑∞
    function displayTimeGraph(records, container) {
        const recordMap = {};
        records.forEach(record => {
            if (record.date && !recordMap[record.date]) {
                recordMap[record.date] = record;
            }
        });

        const sortedDates = Object.keys(recordMap).sort((a, b) => a.localeCompare(b));

        if (sortedDates.length === 0) {
            container.innerHTML = '<div class="empty-state" data-lang-ko="Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§." data-lang-en="No data available.">Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            applyLanguage();
            return;
        }

        const graphData = [];
        sortedDates.forEach(date => {
            const record = recordMap[date];
            if (record.time) {
                const [hours, minutes] = record.time.split(':');
                const timeValue = parseInt(hours) + parseInt(minutes) / 60;
                graphData.push({
                    date: date,
                    value: timeValue
                });
            }
        });

        let html = '';
        if (graphData.length > 0) {
            html += `<div style="background: white; padding: 20px; width: 100%; overflow: hidden;">`;
            html += `<canvas id="timeGraph" style="width: 100%; height: 400px;"></canvas>`;
            html += `</div>`;
        }

        container.innerHTML = html;

        if (graphData.length > 0) {
            // Canvas ÎÑàÎπÑÎ•º Ïª®ÌÖåÏù¥ÎÑàÏóê ÎßûÏ∂§
            const canvas = document.getElementById('timeGraph');
            const containerWidth = canvas.parentElement.clientWidth - 40; // padding Ï†úÏô∏
            canvas.width = containerWidth;
            canvas.height = 400;
            drawTimeGraph(graphData);
        }
    }

    // TIME Í∑∏ÎûòÌîÑ Í∑∏Î¶¨Í∏∞
    function drawTimeGraph(data) {
        const canvas = document.getElementById('timeGraph');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const padding = 60;

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, width, height);

        if (data.length === 0) return;

        const minTime = 0;
        const maxTime = 24;
        const xStep = (width - padding * 2) / (data.length - 1 || 1);

        // YÏ∂ï Í≤©ÏûêÏÑ†
        ctx.strokeStyle = '#e5e5e5';
        ctx.lineWidth = 1;

        for (let h = 0; h <= 24; h += 6) {
            const y = padding + (height - padding * 2) * (1 - h / 24);
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();

            ctx.fillStyle = '#999';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'right';
            const label = currentLang === 'ko' ? `${h}Ïãú` : `${h}h`;
            ctx.fillText(label, padding - 10, y + 4);
        }

        // ÏÑ† Í∑∏ÎûòÌîÑ
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 2;
        ctx.beginPath();

        data.forEach((point, index) => {
            const x = padding + index * xStep;
            const y = padding + (height - padding * 2) * (1 - point.value / 24);

            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        ctx.stroke();

        // Ï†ê
        data.forEach((point, index) => {
            const x = padding + index * xStep;
            const y = padding + (height - padding * 2) * (1 - point.value / 24);

            ctx.fillStyle = '#3b82f6';
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
        });

        // XÏ∂ï Î†àÏù¥Î∏î
        ctx.fillStyle = '#999';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        const labelStep = Math.max(1, Math.ceil(data.length / 10));

        data.forEach((point, index) => {
            if (index % labelStep === 0 || index === data.length - 1) {
                const x = padding + index * xStep;
                ctx.fillText(point.date, x, height - 25);
            }
        });
    }

    // TIME ÌÖåÏù¥Î∏î Î∑∞
    function displayTimeTable(records, container) {
        const recordMap = {};
        records.forEach(record => {
            if (record.date && !recordMap[record.date]) {
                recordMap[record.date] = record;
            }
        });

        const sortedDates = Object.keys(recordMap).sort((a, b) => a.localeCompare(b));

        if (sortedDates.length === 0) {
            container.innerHTML = '<div class="empty-state">Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            return;
        }

        let html = '<table class="time-table">';

        for (let i = 0; i < sortedDates.length; i += 10) {
            const chunk = sortedDates.slice(i, i + 10);

            // ÎÇ†Ïßú Ìñâ
            html += '<tr>';
            chunk.forEach(date => {
                html += `<td class="date-cell">${date}</td>`;
            });
            for (let j = chunk.length; j < 10; j++) {
                html += '<td class="empty-cell"></td>';
            }
            html += '</tr>';

            // ÏãúÍ∞Ñ Ìñâ
            html += '<tr>';
            chunk.forEach(date => {
                const record = recordMap[date];
                html += `<td class="time-cell">${record.time}</td>`;
            });
            for (let j = chunk.length; j < 10; j++) {
                html += '<td class="empty-cell"></td>';
            }
            html += '</tr>';
        }

        html += '</table>';
        container.innerHTML = html;
    }

    // NUMBER Í∑∏ÎûòÌîÑ Î∑∞
    function displayNumberGraph(records, container) {
        const recordMap = {};
        records.forEach(record => {
            if (record.date && !recordMap[record.date]) {
                recordMap[record.date] = record;
            }
        });

        const sortedDates = Object.keys(recordMap).sort((a, b) => a.localeCompare(b));

        if (sortedDates.length === 0) {
            container.innerHTML = '<div class="empty-state" data-lang-ko="Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§." data-lang-en="No data available.">Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            applyLanguage();
            return;
        }

        const graphData = [];
        sortedDates.forEach(date => {
            const record = recordMap[date];
            if (record.number !== undefined && record.number !== null) {
                graphData.push({
                    date: date,
                    value: parseFloat(record.number)
                });
            }
        });

        let html = '';
        if (graphData.length > 0) {
            html += `<div style="background: white; padding: 20px; width: 100%; overflow: hidden;">`;
            html += `<canvas id="numberGraph" style="width: 100%; height: 400px;"></canvas>`;
            html += `</div>`;
        }

        container.innerHTML = html;

        if (graphData.length > 0) {
            // Canvas ÎÑàÎπÑÎ•º Ïª®ÌÖåÏù¥ÎÑàÏóê ÎßûÏ∂§
            const canvas = document.getElementById('numberGraph');
            const containerWidth = canvas.parentElement.clientWidth - 40; // padding Ï†úÏô∏
            canvas.width = containerWidth;
            canvas.height = 400;
            drawNumberGraph(graphData);
        }
    }

    // NUMBER Í∑∏ÎûòÌîÑ Í∑∏Î¶¨Í∏∞
    function drawNumberGraph(data) {
        const canvas = document.getElementById('numberGraph');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const padding = 60;

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, width, height);

        if (data.length === 0) return;

        const allValues = data.map(d => d.value);
        const minValue = Math.min(...allValues);
        const maxValue = Math.max(...allValues);
        const valueRange = maxValue - minValue;
        const rangeMin = Math.floor(minValue - valueRange * 0.1);
        const rangeMax = Math.ceil(maxValue + valueRange * 0.1);

        const xStep = (width - padding * 2) / (data.length - 1 || 1);

        // YÏ∂ï Í≤©ÏûêÏÑ†
        ctx.strokeStyle = '#e5e5e5';
        ctx.lineWidth = 1;

        const valueStep = (rangeMax - rangeMin) / 6;
        for (let i = 0; i <= 6; i++) {
            const val = rangeMin + valueStep * i;
            const y = padding + (height - padding * 2) * (1 - (val - rangeMin) / (rangeMax - rangeMin));
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();

            ctx.fillStyle = '#999';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(val.toFixed(1), padding - 10, y + 4);
        }

        // ÏÑ† Í∑∏ÎûòÌîÑ
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 2;
        ctx.beginPath();

        data.forEach((point, index) => {
            const x = padding + index * xStep;
            const y = padding + (height - padding * 2) * (1 - (point.value - rangeMin) / (rangeMax - rangeMin));

            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        ctx.stroke();

        // Ï†ê
        data.forEach((point, index) => {
            const x = padding + index * xStep;
            const y = padding + (height - padding * 2) * (1 - (point.value - rangeMin) / (rangeMax - rangeMin));

            ctx.fillStyle = '#3b82f6';
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
        });

        // XÏ∂ï Î†àÏù¥Î∏î
        ctx.fillStyle = '#999';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        const labelStep = Math.max(1, Math.ceil(data.length / 10));

        data.forEach((point, index) => {
            if (index % labelStep === 0 || index === data.length - 1) {
                const x = padding + index * xStep;
                ctx.fillText(point.date, x, height - 25);
            }
        });
    }

    // NUMBER ÌÖåÏù¥Î∏î Î∑∞
    function displayNumberTable(records, container) {
        const recordMap = {};
        records.forEach(record => {
            if (record.date && !recordMap[record.date]) {
                recordMap[record.date] = record;
            }
        });

        const sortedDates = Object.keys(recordMap).sort((a, b) => a.localeCompare(b));

        if (sortedDates.length === 0) {
            container.innerHTML = '<div class="empty-state">Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            return;
        }

        let html = '<table class="time-table">';

        for (let i = 0; i < sortedDates.length; i += 10) {
            const chunk = sortedDates.slice(i, i + 10);

            // ÎÇ†Ïßú Ìñâ
            html += '<tr>';
            chunk.forEach(date => {
                html += `<td class="date-cell">${date}</td>`;
            });
            for (let j = chunk.length; j < 10; j++) {
                html += '<td class="empty-cell"></td>';
            }
            html += '</tr>';

            // ÏàòÏπò Ìñâ
            html += '<tr>';
            chunk.forEach(date => {
                const record = recordMap[date];
                html += `<td class="time-cell">${record.number}</td>`;
            });
            for (let j = chunk.length; j < 10; j++) {
                html += '<td class="empty-cell"></td>';
            }
            html += '</tr>';
        }

        html += '</table>';
        container.innerHTML = html;
    }

    // TEXT Ï£ºÍ∞Ñ Î∑∞
    function displayTextWeekly(records, container) {
        // ÎÇ†ÏßúÎ≥ÑÎ°ú Î†àÏΩîÎìú Í∑∏Î£πÌôî
        const recordsByDate = {};
        records.forEach(record => {
            if (record.date) {
                if (!recordsByDate[record.date]) {
                    recordsByDate[record.date] = [];
                }
                recordsByDate[record.date].push(record);
            }
        });

        // Ïù¥Î≤à Ï£º ÏõîÏöîÏùº Í≥ÑÏÇ∞ (Ï≤´ Ìò∏Ï∂úÏãú)
        if (!currentWeekStart) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() + diff);
            currentWeekStart.setHours(0, 0, 0, 0);
        }

        // Ï£ºÍ∞Ñ ÎÇ†Ïßú Í≥ÑÏÇ∞
        const weekDates = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(currentWeekStart.getDate() + i);
            weekDates.push(date);
        }

        // Ï£ºÍ∞Ñ Ï†úÎ™© Í≥ÑÏÇ∞
        const startMonth = currentWeekStart.getMonth() + 1;
        const startDay = currentWeekStart.getDate();
        const endDate = new Date(currentWeekStart);
        endDate.setDate(currentWeekStart.getDate() + 6);
        const endMonth = endDate.getMonth() + 1;
        const endDay = endDate.getDate();

        let weekTitleKo = '';
        let weekTitleEn = '';
        if (startMonth === endMonth) {
            weekTitleKo = `${startMonth}Ïõî ${startDay}-${endDay}Ïùº`;
            weekTitleEn = `${startMonth}/${startDay}-${endDay}`;
        } else {
            weekTitleKo = `${startMonth}Ïõî ${startDay}Ïùº - ${endMonth}Ïõî ${endDay}Ïùº`;
            weekTitleEn = `${startMonth}/${startDay} - ${endMonth}/${endDay}`;
        }

        let html = '';

        // Ï£ºÍ∞Ñ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        html += '<div class="weekly-nav">';
        html += `<button class="weekly-nav-btn" onclick="changeWeek(-1)">‚óÄ</button>`;
        html += `<div class="weekly-title-container">`;
        html += `<div class="weekly-title" data-lang-ko="${weekTitleKo}" data-lang-en="${weekTitleEn}">${currentLang === 'ko' ? weekTitleKo : weekTitleEn}</div>`;
        const navYear = currentWeekStart.getFullYear();
        const navMonth = String(currentWeekStart.getMonth() + 1).padStart(2, '0');
        const navDay = String(currentWeekStart.getDate()).padStart(2, '0');
        const dateValue = `${navYear}-${navMonth}-${navDay}`;
        html += `<input type="date" class="week-date-picker" value="${dateValue}" onchange="jumpToWeek(this.value)">`;
        html += `</div>`;
        html += `<button class="weekly-nav-btn" onclick="changeWeek(1)">‚ñ∂</button>`;
        html += '</div>';

        // Ï£ºÍ∞Ñ Í∑∏Î¶¨Îìú
        html += '<div class="weekly-grid">';

        const dayNamesKo = ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº'];
        const dayNamesEn = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        weekDates.forEach((date, index) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            const dateRecords = recordsByDate[dateStr] || [];

            const dayNum = date.getDate();
            const dayNameKo = dayNamesKo[index];
            const dayNameEn = dayNamesEn[index];

            // Îç∞Ïù¥ÌÑ∞ Ïú†Î¨¥Ïóê Îî∞Î•∏ ÏÉâÏÉÅ
            const colorClass = dateRecords.length > 0 ? 'weekly-has-data' : '';

            html += `<div class="weekly-day ${colorClass}">`;
            html += `<div class="weekly-day-header">`;
            html += `<div class="weekly-day-name" data-lang-ko="${dayNameKo}" data-lang-en="${dayNameEn}">${currentLang === 'ko' ? dayNameKo : dayNameEn}</div>`;
            html += `<div class="weekly-day-num">${dayNum}</div>`;
            html += `</div>`;
            html += `<div class="weekly-day-content">`;

            if (dateRecords.length > 0) {
                dateRecords.forEach(record => {
                    html += `<div class="text-weekly-item">`;
                    html += `<div class="text-weekly-title">${record.title}</div>`;
                    html += `<div class="text-weekly-text">${record.text}</div>`;
                    html += `</div>`;
                });
            } else {
                html += `<div class="weekly-empty">-</div>`;
            }

            html += `</div>`;
            html += `</div>`;
        });

        html += '</div>';

        container.innerHTML = html;
    }

    // TEXT Î¶¨Ïä§Ìä∏ Î∑∞
    function displayTextList(records, container) {
        const sortedRecords = [...records].sort((a, b) => b.date.localeCompare(a.date));

        let html = '<div class="text-list">';
        sortedRecords.forEach(record => {
            html += `
                <div class="text-item">
                    <div class="text-item-header">
                        <div class="text-item-title">${record.title}</div>
                        <div class="text-item-date">${record.date}</div>
                    </div>
                    <div class="category-description">${record.text}</div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    // CHECKLIST Ï£ºÍ∞Ñ Î∑∞
    function displayChecklistWeekly(records, container) {
        // ÎÇ†ÏßúÎ≥ÑÎ°ú Î†àÏΩîÎìú Í∑∏Î£πÌôî
        const recordsByDate = {};
        records.forEach(record => {
            if (record.date) {
                if (!recordsByDate[record.date]) {
                    recordsByDate[record.date] = [];
                }
                recordsByDate[record.date].push(record);
            }
        });

        // Ïù¥Î≤à Ï£º ÏõîÏöîÏùº Í≥ÑÏÇ∞ (Ï≤´ Ìò∏Ï∂úÏãú)
        if (!currentWeekStart) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() + diff);
            currentWeekStart.setHours(0, 0, 0, 0);
        }

        // Ï£ºÍ∞Ñ ÎÇ†Ïßú Í≥ÑÏÇ∞
        const weekDates = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(currentWeekStart.getDate() + i);
            weekDates.push(date);
        }

        // Ï£ºÍ∞Ñ Ï†úÎ™© Í≥ÑÏÇ∞
        const startMonth = currentWeekStart.getMonth() + 1;
        const startDay = currentWeekStart.getDate();
        const endDate = new Date(currentWeekStart);
        endDate.setDate(currentWeekStart.getDate() + 6);
        const endMonth = endDate.getMonth() + 1;
        const endDay = endDate.getDate();

        let weekTitleKo = '';
        let weekTitleEn = '';
        if (startMonth === endMonth) {
            weekTitleKo = `${startMonth}Ïõî ${startDay}-${endDay}Ïùº`;
            weekTitleEn = `${startMonth}/${startDay}-${endDay}`;
        } else {
            weekTitleKo = `${startMonth}Ïõî ${startDay}Ïùº - ${endMonth}Ïõî ${endDay}Ïùº`;
            weekTitleEn = `${startMonth}/${startDay} - ${endMonth}/${endDay}`;
        }

        let html = '';

        // Ï£ºÍ∞Ñ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        html += '<div class="weekly-nav">';
        html += `<button class="weekly-nav-btn" onclick="changeWeek(-1)">‚óÄ</button>`;
        html += `<div class="weekly-title-container">`;
        html += `<div class="weekly-title" data-lang-ko="${weekTitleKo}" data-lang-en="${weekTitleEn}">${currentLang === 'ko' ? weekTitleKo : weekTitleEn}</div>`;
        const navYear = currentWeekStart.getFullYear();
        const navMonth = String(currentWeekStart.getMonth() + 1).padStart(2, '0');
        const navDay = String(currentWeekStart.getDate()).padStart(2, '0');
        const dateValue = `${navYear}-${navMonth}-${navDay}`;
        html += `<input type="date" class="week-date-picker" value="${dateValue}" onchange="jumpToWeek(this.value)">`;
        html += `</div>`;
        html += `<button class="weekly-nav-btn" onclick="changeWeek(1)">‚ñ∂</button>`;
        html += '</div>';

        // Ï£ºÍ∞Ñ Í∑∏Î¶¨Îìú
        html += '<div class="weekly-grid">';

        const dayNamesKo = ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº'];
        const dayNamesEn = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        weekDates.forEach((date, index) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            const dateRecords = recordsByDate[dateStr] || [];

            const dayNum = date.getDate();
            const dayNameKo = dayNamesKo[index];
            const dayNameEn = dayNamesEn[index];

            // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Ìù∞ÏÉâ Î∞∞Í≤Ω
            let colorClass = '';
            if (dateRecords.length > 0) {
                colorClass = 'weekly-has-data';
            }

            html += `<div class="weekly-day ${colorClass}">`;
            html += `<div class="weekly-day-header">`;
            html += `<div class="weekly-day-name" data-lang-ko="${dayNameKo}" data-lang-en="${dayNameEn}">${currentLang === 'ko' ? dayNameKo : dayNameEn}</div>`;
            html += `<div class="weekly-day-num">${dayNum}</div>`;
            html += `</div>`;
            html += `<div class="weekly-day-content">`;

            if (dateRecords.length > 0) {
                dateRecords.forEach(record => {
                    const status = record.success ? 'O' : 'X';
                    const statusClass = record.success ? 'completed' : 'incomplete';
                    html += `<div class="weekly-todo-item ${statusClass}">`;
                    html += `<span class="weekly-todo-status">${status}</span>`;
                    html += `<span class="weekly-todo-text">${record.todo}</span>`;
                    html += `</div>`;
                });
            } else {
                html += `<div class="weekly-empty">-</div>`;
            }

            html += `</div>`;
            html += `</div>`;
        });

        html += '</div>';

        container.innerHTML = html;
    }

    // Ï£ºÍ∞Ñ Î≥ÄÍ≤Ω Ìï®Ïàò
    function changeWeek(weeks) {
        if (!currentWeekStart) return;
        currentWeekStart.setDate(currentWeekStart.getDate() + (weeks * 7));
        renderCurrentView(allRecords, currentCategory);
    }

    // Ï£ºÍ∞Ñ ÎÇ†Ïßú Ïù¥Îèô Ìï®Ïàò
    function jumpToWeek(dateString) {
        const selectedDate = new Date(dateString);
        const dayOfWeek = selectedDate.getDay();
        const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        currentWeekStart = new Date(selectedDate);
        currentWeekStart.setDate(selectedDate.getDate() + diff);
        currentWeekStart.setHours(0, 0, 0, 0);
        renderCurrentView(allRecords, currentCategory);
    }

    // CHECKLIST Î¶¨Ïä§Ìä∏ Î∑∞
    function displayChecklistList(records, container) {
        const groupedByDate = records.reduce((acc, record) => {
            const date = record.date;
            if (!acc[date]) acc[date] = [];
            acc[date].push(record);
            return acc;
        }, {});

        const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));

        let html = '';
        sortedDates.forEach(date => {
            html += `<div class="checklist-group">`;
            html += `<div class="checklist-date">${date}</div>`;
            html += `<div class="checklist-items">`;

            groupedByDate[date].forEach(record => {
                const checked = record.success ? 'checked' : '';
                html += `
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${checked}"></div>
                        <div class="checklist-todo">${record.todo}</div>
                    </div>
                `;
            });

            html += `</div></div>`;
        });

        container.innerHTML = html;
    }

    // UI Ìï®Ïàò
    function showLoginSection() {
        document.getElementById('mainSection').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('signupSection').style.display = 'none';
        applyLanguage();
    }

    function showSignupSection() {
        document.getElementById('mainSection').style.display = 'none';
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('signupSection').style.display = 'block';
        applyLanguage();
    }

    function showMainSection() {
        document.getElementById('mainSection').style.display = 'block';
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('signupSection').style.display = 'none';
        applyLanguage();
    }

    function showError(elementId, message) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="error-message">${message}</div>`;
        setTimeout(() => {
            element.innerHTML = '';
        }, 5000);
    }

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    document.getElementById('showSignup').addEventListener('click', (e) => {
        e.preventDefault();
        showSignupSection();
    });

    document.getElementById('showLogin').addEventListener('click', (e) => {
        e.preventDefault();
        showLoginSection();
    });

    document.getElementById('cancelSignup').addEventListener('click', () => {
        showMainSection();
    });

    document.getElementById('loginForm').addEventListener('submit', login);
    document.getElementById('signupForm').addEventListener('submit', signup);

    // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
    document.getElementById('recordsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeRecordsModal();
        }
    });
</script>

<!-- ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º Ïª®ÌÖåÏù¥ÎÑà -->
<div class="toast-container" id="toastContainer"></div>

<!-- ÏïåÎ¶º Î™©Î°ù Î™®Îã¨ -->
<div class="notification-modal" id="notificationModal">
    <div class="notification-modal-content">
        <div class="notification-modal-header">
            <div class="notification-modal-title" data-lang-ko="ÏïåÎ¶º" data-lang-en="Notifications">ÏïåÎ¶º</div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="mark-all-read-btn" onclick="markAllAsRead()" data-lang-ko="Î™®Îëê ÏùΩÏùå" data-lang-en="Mark all as read">Î™®Îëê ÏùΩÏùå</button>
                <button class="notification-modal-close" onclick="toggleNotificationModal()">√ó</button>
            </div>
        </div>
        <div class="notification-list" id="notificationList">
            <div class="notification-empty" data-lang-ko="ÏïåÎ¶ºÏù¥ ÏóÜÏäµÎãàÎã§" data-lang-en="No notifications">ÏïåÎ¶ºÏù¥ ÏóÜÏäµÎãàÎã§</div>
        </div>
    </div>
</div>

<script>
    // ========== NOTIFICATION SYSTEM ==========

    let sseAbortController = null;
    let notifications = [];
    let unreadCount = 0;
    let sseReconnectAttempts = 0;
    const MAX_SSE_RECONNECT = 3;
    let isInitialized = false; // Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÌîåÎûòÍ∑∏

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏùΩÏßÄ ÏïäÏùÄ ÏïåÎ¶º Í∞ÄÏ†∏Ïò§Í∏∞
    async function loadUnreadNotifications() {
        console.log('>>> loadUnreadNotifications ÏãúÏûë');
        isInitialized = false; // Ï¥àÍ∏∞Ìôî ÏãúÏûë

        try {
            const response = await apiCall('/notification/unread');

            if (response.ok) {
                const data = await response.json();
                notifications = data || [];
                console.log('ÏùΩÏßÄ ÏïäÏùÄ ÏïåÎ¶º Î°úÎìú:', notifications.length, 'Í∞ú');
                console.log('ÏïåÎ¶º Îç∞Ïù¥ÌÑ∞:', notifications);

                // ÏùΩÏßÄ ÏïäÏùÄ Í∞úÏàò Í∞ÄÏ†∏Ïò§Í∏∞
                await loadUnreadCount();

                isInitialized = true; // Ï¥àÍ∏∞Ìôî ÏôÑÎ£å
                console.log('>>> loadUnreadNotifications ÏôÑÎ£å - unreadCount:', unreadCount);
            }
        } catch (error) {
            isInitialized = true; // Ïò§Î•òÏó¨ÎèÑ Ï¥àÍ∏∞Ìôî ÏôÑÎ£åÎ°ú ÌëúÏãú
        }
    }

    // ÏùΩÏßÄ ÏïäÏùÄ ÏïåÎ¶º Í∞úÏàò Í∞ÄÏ†∏Ïò§Í∏∞
    async function loadUnreadCount() {
        console.log('>>> loadUnreadCount ÏãúÏûë');
        try {
            const response = await apiCall('/notification/unread/count');

            console.log('loadUnreadCount response status:', response.status);

            if (response.ok) {
                const count = await response.json();
                console.log('APIÏóêÏÑú Î∞õÏùÄ count:', count, '(ÌÉÄÏûÖ:', typeof count, ')');

                // Í∞ùÏ≤¥ ÎòêÎäî Ïà´Ïûê Ï≤òÎ¶¨ (APIÍ∞Ä {count: 4} ÌòïÌÉúÎ°ú Î∞òÌôò)
                let actualCount = 0;
                if (typeof count === 'object' && count !== null && 'count' in count) {
                    actualCount = count.count;
                    console.log('Í∞ùÏ≤¥ÏóêÏÑú count Ï∂îÏ∂ú:', actualCount);
                } else if (typeof count === 'number') {
                    actualCount = count;
                }

                // Í∞ïÎ†•Ìïú ÌÉÄÏûÖ Ï≤¥ÌÅ¨ - Ïà´ÏûêÎ°ú Î≥ÄÌôò
                unreadCount = Number(actualCount) || 0;
                console.log('ÏÑ§Ï†ïÎêú unreadCount:', unreadCount, '(ÌÉÄÏûÖ:', typeof unreadCount, ')');

                updateNotificationBadge();
                console.log('>>> loadUnreadCount ÏôÑÎ£å');
            } else {
                unreadCount = 0;
            }
        } catch (error) {
            unreadCount = 0; // Ïò§Î•ò Ïãú 0ÏúºÎ°ú Ï¥àÍ∏∞Ìôî
        }
    }

    // ÏïåÎ¶ºÏùÑ ÏùΩÏùå Ï≤òÎ¶¨
    async function markNotificationsAsRead(notificationIds) {
        try {
            const response = await apiCall(`/notification/unread`, {
                method: 'POST',
                body: JSON.stringify({
                    notificationIds: notificationIds
                })
            });

            if (response.ok) {
                console.log('ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨ ÏôÑÎ£å:', notificationIds.length);
                // ÏùΩÏùå Ï≤òÎ¶¨ ÌõÑ Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
                await loadUnreadCount();
            }
        } catch (error) {
            console.error('ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨ Ïò§Î•ò:', error);
        }
    }

    // SSE Ïó∞Í≤∞
    async function connectSSE() {
        // Í∏∞Ï°¥ Ïó∞Í≤∞Ïù¥ ÏûàÏúºÎ©¥ Ï§ëÎã®
        if (sseAbortController) {
            sseAbortController.abort();
            sseAbortController = null;
        }

        // ÏµúÎåÄ Ïû¨Ïó∞Í≤∞ ÌöüÏàò Ï¥àÍ≥º Ïãú Ï§ëÎã®
        if (sseReconnectAttempts >= MAX_SSE_RECONNECT) {
            console.warn('SSE ÏµúÎåÄ Ïû¨Ïó∞Í≤∞ ÌöüÏàò Ï¥àÍ≥º. ÏïåÎ¶º Í∏∞Îä•Ïù¥ ÎπÑÌôúÏÑ±ÌôîÎê©ÎãàÎã§.');
            return;
        }

        // Access Token ÌôïÏù∏
        const token = getAccessToken();
        if (!token) {
            console.warn('Access Token ÏóÜÏùå, SSE Ïó∞Í≤∞ Î∂àÍ∞Ä');
            return;
        }

        console.log(`SSE Ïó∞Í≤∞ ÏãúÎèÑ (${sseReconnectAttempts + 1}/${MAX_SSE_RECONNECT})`);

        // AbortController ÏÉùÏÑ±
        sseAbortController = new AbortController();

        try {
            await fetchEventSource(`${API_BASE}/sse/subscribe`, {
                method: 'GET',
                    'Authorization': `Bearer ${token}`
                signal: sseAbortController.signal,

                onopen: async (response) => {
                    if (response.ok) {
                        console.log('‚úÖ SSE Ïó∞Í≤∞ ÏÑ±Í≥µ (Authorization header)');
                        sseReconnectAttempts = 0;
                        return;
                    } else if (response.status === 401) {
                        console.error('‚ùå SSE Ïù∏Ï¶ù Ïã§Ìå® (401)');
                        throw new Error('Unauthorized');
                    } else {
                        console.error('‚ùå SSE Ïó∞Í≤∞ Ïã§Ìå®:', response.status);
                        throw new Error('Connection failed');
                    }
                },

                onmessage: (event) => {
                    try {
                        const eventType = event.event || 'message';

                        if (eventType === 'connected') {
                            console.log('SSE connected Ïù¥Î≤§Ìä∏ ÏàòÏã†');
                        } else if (eventType === 'ping') {
                            console.log('SSE ping ÏàòÏã†');
                        } else if (eventType === 'notification') {
                            const data = JSON.parse(event.data);
                            console.log('ÏïåÎ¶º ÏàòÏã†:', data);
                            handleNotification(data.body || data);
                        }
                    } catch (error) {
                        console.error('ÏïåÎ¶º ÌååÏã± Ïò§Î•ò:', error);
                    }
                },

                onerror: (error) => {
                    console.error('SSE Ïó∞Í≤∞ Ïò§Î•ò:', error);
                    sseReconnectAttempts++;

                    if (sseReconnectAttempts < MAX_SSE_RECONNECT) {
                        console.log(`${5}Ï¥à ÌõÑ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ...`);
                        throw error;
                    } else {
                        console.warn('SSE Ïû¨Ïó∞Í≤∞ Ïã§Ìå®. ÏïåÎ¶º Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
                        throw error;
                    }
                },

                onclose: () => {
                    console.log('SSE Ïó∞Í≤∞ Ï¢ÖÎ£å');
                }
            });
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('SSE Ïó∞Í≤∞Ïù¥ ÏàòÎèôÏúºÎ°ú Ï§ëÎã®ÎêòÏóàÏäµÎãàÎã§.');
            } else {
                console.error('SSE Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);

                if (sseReconnectAttempts < MAX_SSE_RECONNECT) {
                    setTimeout(() => {
                        connectSSE();
                    }, 5000);
                }
            }
        }
    }

    // ÏïåÎ¶º Ï≤òÎ¶¨
    function handleNotification(notification) {
        // ÏïåÎ¶º Ï†ÄÏû• (Îß® ÏïûÏóê Ï∂îÍ∞Ä)
        notifications.unshift(notification);

        // NaN Î∞©ÏßÄ - ÌòÑÏû¨ Í∞íÏù¥ Ïà´ÏûêÍ∞Ä ÏïÑÎãàÎ©¥ 0ÏúºÎ°ú Ï¥àÍ∏∞Ìôî
        if (isNaN(unreadCount)) {
            console.warn('unreadCountÍ∞Ä NaNÏûÖÎãàÎã§! 0ÏúºÎ°ú Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§.');
            unreadCount = 0;
        }

        unreadCount++;

        console.log('ÏÉà ÏïåÎ¶º ÏàòÏã†:', notification.type, '/ ÌòÑÏû¨ ÏùΩÏßÄ ÏïäÏùÄ ÏïåÎ¶º:', unreadCount, '(ÌÉÄÏûÖ:', typeof unreadCount, ')');

        // Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
        updateNotificationBadge();

        // ÌÜ†Ïä§Ìä∏ ÌëúÏãú
        showToast(notification);

        // ÏïåÎ¶º Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ (Î™®Îã¨Ïù¥ Ïó¥Î†§ÏûàÏúºÎ©¥)
        if (document.getElementById('notificationModal').classList.contains('active')) {
            renderNotificationList();
            updateMarkAllReadButton();
        }
    }

    // Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
    function updateNotificationBadge() {
        const badge = document.getElementById('notificationBadge');
        const bell = document.getElementById('notificationBell');

        console.log('=== Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ ÎîîÎ≤ÑÍπÖ ===');
        console.log('unreadCount:', unreadCount, '(ÌÉÄÏûÖ:', typeof unreadCount, ', NaN?', isNaN(unreadCount), ')');
        console.log('badge ÏöîÏÜå:', badge);
        console.log('bell ÏöîÏÜå:', bell);

        if (!badge) {
            console.error('Î∞∞ÏßÄ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
            return;
        }

        // NaN Ï≤¥ÌÅ¨
        if (isNaN(unreadCount)) {
            console.error('unreadCountÍ∞Ä NaNÏûÖÎãàÎã§! 0ÏúºÎ°ú Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§.');
            unreadCount = 0;
        }

        if (unreadCount > 0) {
            const displayCount = unreadCount > 99 ? '99+' : unreadCount;
            badge.textContent = displayCount;
            badge.style.display = 'block';
            console.log('Î∞∞ÏßÄ ÌëúÏãú:', displayCount);
        } else {
            badge.style.display = 'none';
            console.log('Î∞∞ÏßÄ Ïà®ÍπÄ');
        }
    }

    // ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º ÌëúÏãú
    function showToast(notification) {
        const container = document.getElementById('toastContainer');

        const toast = document.createElement('div');
        toast.className = `toast-notification ${notification.type.toLowerCase()}`;

        // ÌÉÄÏûÖÎ≥Ñ Ï†úÎ™©
        let title = '';
        if (notification.type === 'COMMENT') {
            title = currentLang === 'ko' ? 'ÏÉà ÎåìÍ∏Ä' : 'New Comment';
        } else if (notification.type === 'REPLY') {
            title = currentLang === 'ko' ? 'ÏÉà ÎåÄÎåìÍ∏Ä' : 'New Reply';
        } else if (notification.type === 'LIKE') {
            title = currentLang === 'ko' ? 'ÏÉà Ï¢ãÏïÑÏöî' : 'New Like';
        } else if (notification.type === 'FRIEND_REQUEST') {
            title = currentLang === 'ko' ? 'ÏπúÍµ¨ ÏöîÏ≤≠' : 'Friend Request';
        } else if (notification.type === 'FRIEND_ACCEPT') {
            title = currentLang === 'ko' ? 'ÏπúÍµ¨ ÏàòÎùΩ' : 'Friend Accepted';
        } else if (notification.type === 'FRIEND_REJECT') {
            title = currentLang === 'ko' ? 'ÏπúÍµ¨ Í±∞Ï†à' : 'Friend Rejected';
        }

        const categoryTitle = notification.data.categoryTitle || '';
        const categoryPrefix = categoryTitle ? `[${categoryTitle}] ` : '';

        // ÌÉÄÏûÖÎ≥Ñ Î©îÏãúÏßÄ
        let message = '';
        if (notification.type === 'COMMENT') {
            message = `${categoryPrefix}${notification.data.senderEmail}: ${notification.data.comment}`;
        } else if (notification.type === 'REPLY') {
            const myComment = notification.data.myComment || '';
            const myCommentPreview = myComment.length > 20 ? myComment.substring(0, 20) + '...' : myComment;
            message = `${categoryPrefix}${notification.data.senderEmail}${currentLang === 'ko' ? 'ÎãòÏù¥ ÎãµÍ∏ÄÏùÑ ÎÇ®Í≤ºÏäµÎãàÎã§' : ' replied'}: "${myCommentPreview}" ‚Üí ${notification.data.comment}`;
        } else if (notification.type === 'LIKE') {
            message = `${categoryPrefix}${notification.data.senderEmail}${currentLang === 'ko' ? 'ÎãòÏù¥ Ï¢ãÏïÑÏöîÎ•º ÎàåÎ†ÄÏäµÎãàÎã§' : ' liked your category'}`;
        } else if (notification.type === 'FRIEND_REQUEST') {
            const requesterEmail = notification.data.requesterEmail || notification.senderEmail || '';
            message = currentLang === 'ko'
                ? `${requesterEmail}ÎãòÏù¥ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§`
                : `${requesterEmail} sent you a friend request`;
        } else if (notification.type === 'FRIEND_ACCEPT') {
            const senderName = notification.data.senderName || notification.data.senderEmail || '';
            message = currentLang === 'ko'
                ? `${senderName}ÎãòÏù¥ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ ÏàòÎùΩÌñàÏäµÎãàÎã§`
                : `${senderName} accepted your friend request`;
        } else if (notification.type === 'FRIEND_REJECT') {
            const senderName = notification.data.senderName || notification.data.senderEmail || '';
            message = currentLang === 'ko'
                ? `${senderName}ÎãòÏù¥ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Í±∞Ï†àÌñàÏäµÎãàÎã§`
                : `${senderName} rejected your friend request`;
        }

        const time = new Date(notification.createdAt).toLocaleTimeString(currentLang === 'ko' ? 'ko-KR' : 'en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });

        toast.innerHTML = `
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
            <div class="toast-time">${time}</div>
        `;

        toast.onclick = () => {
            toggleNotificationModal();
            toast.remove();
        };

        container.appendChild(toast);

        // 5Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(400px)';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // ÏïåÎ¶º Î™®Îã¨ ÌÜ†Í∏Ä
    function toggleNotificationModal() {
        const modal = document.getElementById('notificationModal');
        modal.classList.toggle('active');

        if (modal.classList.contains('active')) {
            renderNotificationList();
            updateMarkAllReadButton();
        }
    }

    // Î™®Îëê ÏùΩÏùå Ï≤òÎ¶¨
    async function markAllAsRead() {
        if (notifications.length === 0) return;

        const btn = document.querySelector('.mark-all-read-btn');
        btn.disabled = true;
        btn.textContent = currentLang === 'ko' ? 'Ï≤òÎ¶¨ Ï§ë...' : 'Processing...';

        try {
            // ÏùΩÏßÄ ÏïäÏùÄ ÏïåÎ¶º ID ÏàòÏßë
            const unreadIds = notifications
                .filter(n => n.id)
                .map(n => n.id);

            if (unreadIds.length > 0) {
                // ÏïåÎ¶º ÏùΩÏùå Ï≤òÎ¶¨
                await markNotificationsAsRead(unreadIds);

                // ÏïåÎ¶º Î∞∞Ïó¥ ÎπÑÏö∞Í∏∞ (Ï§ëÏöî!)
                notifications = [];

                // UI ÏóÖÎç∞Ïù¥Ìä∏
                unreadCount = 0;
                updateNotificationBadge();

                // Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
                updateMarkAllReadButton();

                // ÏÑ±Í≥µ Î©îÏãúÏßÄ
                console.log('Î™®Îì† ÏïåÎ¶ºÏùÑ ÏùΩÏùå Ï≤òÎ¶¨ÌñàÏäµÎãàÎã§');

                // Î™®Îã¨ Îã´Í∏∞
                toggleNotificationModal();
            }
        } catch (error) {
            alert(currentLang === 'ko' ? 'ÏïåÎ¶º Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§' : 'Failed to mark as read');
        } finally {
            btn.disabled = false;
            btn.textContent = currentLang === 'ko' ? 'Î™®Îëê ÏùΩÏùå' : 'Mark all as read';
        }
    }

    // Î™®Îëê ÏùΩÏùå Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    function updateMarkAllReadButton() {
        const btn = document.querySelector('.mark-all-read-btn');
        if (btn) {
            const hasUnread = notifications.some(n => n.id);
            btn.disabled = !hasUnread || notifications.length === 0;
        }
    }

    // ÏïåÎ¶º Î™©Î°ù Î†åÎçîÎßÅ
    function renderNotificationList() {
        const listContainer = document.getElementById('notificationList');

        if (notifications.length === 0) {
            const emptyText = currentLang === 'ko' ? 'ÏïåÎ¶ºÏù¥ ÏóÜÏäµÎãàÎã§' : 'No notifications';
            listContainer.innerHTML = `<div class="notification-empty">${emptyText}</div>`;
            return;
        }

        let html = '';
        notifications.forEach((notif, index) => {
            // ÌÉÄÏûÖÎ≥Ñ ÌÖçÏä§Ìä∏
            let typeText = '';
            if (notif.type === 'COMMENT') {
                typeText = currentLang === 'ko' ? 'ÎåìÍ∏Ä' : 'Comment';
            } else if (notif.type === 'REPLY') {
                typeText = currentLang === 'ko' ? 'ÎåÄÎåìÍ∏Ä' : 'Reply';
            } else if (notif.type === 'LIKE') {
                typeText = currentLang === 'ko' ? 'Ï¢ãÏïÑÏöî' : 'Like';
            } else if (notif.type === 'FRIEND_REQUEST') {
                typeText = currentLang === 'ko' ? 'ÏπúÍµ¨ ÏöîÏ≤≠' : 'Friend Request';
            } else if (notif.type === 'FRIEND_ACCEPT') {
                typeText = currentLang === 'ko' ? 'ÏàòÎùΩÎê®' : 'Accepted';
            } else if (notif.type === 'FRIEND_REJECT') {
                typeText = currentLang === 'ko' ? 'Í±∞Ï†àÎê®' : 'Rejected';
            }

            const categoryTitle = notif.data.categoryTitle || '';
            const categoryBadge = categoryTitle
                ? `<span style="background: #e8e8e8; padding: 2px 6px; font-size: 10px; font-weight: 600; color: #666; margin-right: 4px; border-radius: 2px;">${categoryTitle}</span>`
                : '';

            // ÌÉÄÏûÖÎ≥Ñ Ïª®ÌÖêÏ∏†
            let content = '';
            if (notif.type === 'COMMENT') {
                content = `${categoryBadge}<span class="notification-item-sender">${notif.data.senderEmail}</span>: ${notif.data.comment}`;
            } else if (notif.type === 'REPLY') {
                const myComment = notif.data.myComment || '';
                const myCommentPreview = myComment.length > 30 ? myComment.substring(0, 30) + '...' : myComment;
                content = `${categoryBadge}<span class="notification-item-sender">${notif.data.senderEmail}</span>${currentLang === 'ko' ? 'ÎãòÏù¥ ÎãµÍ∏ÄÏùÑ ÎÇ®Í≤ºÏäµÎãàÎã§' : ' replied to'}: "<span style="color: #666; font-style: italic;">${myCommentPreview}</span>" ‚Üí ${notif.data.comment}`;
            } else if (notif.type === 'LIKE') {
                content = `${categoryBadge}<span class="notification-item-sender">${notif.data.senderEmail}</span>${currentLang === 'ko' ? 'ÎãòÏù¥ Ï¢ãÏïÑÏöîÎ•º ÎàåÎ†ÄÏäµÎãàÎã§' : ' liked your category'}`;
            } else if (notif.type === 'FRIEND_REQUEST') {
                const requesterEmail = notif.data.requesterEmail || notif.senderEmail || '';
                content = `<span class="notification-item-sender">${requesterEmail}</span>${currentLang === 'ko' ? 'ÎãòÏù¥ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§' : ' sent you a friend request'}`;
            } else if (notif.type === 'FRIEND_ACCEPT') {
                const senderName = notif.data.senderName || notif.data.senderEmail || '';
                content = `<span class="notification-item-sender">${senderName}</span>${currentLang === 'ko' ? 'ÎãòÏù¥ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ ÏàòÎùΩÌñàÏäµÎãàÎã§' : ' accepted your friend request'}`;
            } else if (notif.type === 'FRIEND_REJECT') {
                const senderName = notif.data.senderName || notif.data.senderEmail || '';
                content = `<span class="notification-item-sender">${senderName}</span>${currentLang === 'ko' ? 'ÎãòÏù¥ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Í±∞Ï†àÌñàÏäµÎãàÎã§' : ' rejected your friend request'}`;
            }

            const time = getRelativeTime(new Date(notif.createdAt));

            html += `
                <div class="notification-item ${index < unreadCount ? 'unread' : ''}">
                    <div class="notification-item-header">
                        <span class="notification-item-type ${notif.type.toLowerCase()}">${typeText}</span>
                        <span class="notification-item-time">${time}</span>
                    </div>
                    <div class="notification-item-content">${content}</div>
                </div>
            `;
        });

        listContainer.innerHTML = html;
    }

    // ÏÉÅÎåÄ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
    function getRelativeTime(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000); // Ï¥à Îã®ÏúÑ

        if (diff < 60) return currentLang === 'ko' ? 'Î∞©Í∏à Ï†Ñ' : 'Just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}${currentLang === 'ko' ? 'Î∂Ñ Ï†Ñ' : 'm ago'}`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}${currentLang === 'ko' ? 'ÏãúÍ∞Ñ Ï†Ñ' : 'h ago'}`;
        return `${Math.floor(diff / 86400)}${currentLang === 'ko' ? 'Ïùº Ï†Ñ' : 'd ago'}`;
    }

    // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
    document.getElementById('notificationModal').addEventListener('click', (e) => {
        if (e.target.id === 'notificationModal') {
            toggleNotificationModal();
        }
    });

    // ========== LIKE & COMMENT SYSTEM ==========

    let currentCommentCategoryId = null;
    let currentCommentCategoryTitle = '';
    let replyingToCommentId = null;

    // Ï¢ãÏïÑÏöî ÌÜ†Í∏Ä
    async function toggleLike(event, categoryId) {
        event.stopPropagation();

        // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
        if (!currentUser) {
            alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
            return;
        }

        const btn = event.currentTarget;

        // Ïù¥ÎØ∏ Ï≤òÎ¶¨ Ï§ëÏù¥Î©¥ Î¨¥Ïãú
        if (btn.disabled) return;

        const isLiked = btn.classList.contains('liked');

        // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.style.cursor = 'wait';

        try {
            if (isLiked) {
                // Ï¢ãÏïÑÏöî Ï∑®ÏÜå
                const response = await apiCall(`/categories/likes`, {
                    method: 'DELETE',
                    body: JSON.stringify({ categoryId })
                });

                if (response.ok) {
                    btn.classList.remove('liked');
                    btn.querySelector('.like-icon').textContent = '‚ô°';
                    await loadLikeCount(categoryId);
                } else if (response.status === 401) {
                    alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
                } else {
                    // ÏóêÎü¨ Î∞úÏÉù Ïãú ÏÉÅÌÉú Ïû¨Î°úÎìú (Ï°∞Ïö©Ìûà)
                    console.log('Ï¢ãÏïÑÏöî Ï∑®ÏÜå Ïã§Ìå®, ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ°ú ÎèôÍ∏∞Ìôî');
                    await loadLikeStatus(categoryId);
                    await loadLikeCount(categoryId);
                }
            } else {
                // Ï¢ãÏïÑÏöî Ï∂îÍ∞Ä
                const response = await apiCall(`/categories/likes`, {
                    method: 'POST',
                    body: JSON.stringify({ categoryId })
                });

                if (response.ok) {
                    btn.classList.add('liked');
                    btn.querySelector('.like-icon').textContent = '‚ô•';
                    await loadLikeCount(categoryId);
                } else if (response.status === 401) {
                    alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
                } else {
                    // Ï§ëÎ≥µ Ï¢ãÏïÑÏöî Îì± ÏóêÎü¨ Î∞úÏÉù Ïãú ÏÉÅÌÉú Ïû¨Î°úÎìú (Ï°∞Ïö©Ìûà)
                    console.log('Ï¢ãÏïÑÏöî Ï∂îÍ∞Ä Ïã§Ìå®, ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ°ú ÎèôÍ∏∞Ìôî');
                    await loadLikeStatus(categoryId);
                    await loadLikeCount(categoryId);
                }
            }
        } catch (error) {
            console.error('Ï¢ãÏïÑÏöî ÌÜ†Í∏Ä Ïò§Î•ò:', error);
            // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏóêÎü¨ Îì± Î∞úÏÉù Ïãú ÏÉÅÌÉú Ïû¨Î°úÎìú
            await loadLikeStatus(categoryId);
            await loadLikeCount(categoryId);
        } finally {
            // Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        }
    }

    // Ï¢ãÏïÑÏöî ÏÉÅÌÉú Î°úÎìú (ÏÉà API ÏÇ¨Ïö©)
    async function loadLikeStatus(categoryId) {
        if (!currentUser) return;

        if (!categoryId) {
            console.error('loadLikeStatus: categoryId is missing!');
            return;
        }

        console.log(`loadLikeStatus Ìò∏Ï∂ú: ${categoryId}`);

        try {
            const response = await apiCall('/categories/likes/checks/${categoryId}');

            if (response.ok) {
                const data = await response.json();
                console.log(`Ï¢ãÏïÑÏöî ÏÉÅÌÉú (${categoryId}):`, data.checked);

                const btn = document.querySelector(`[data-category-id="${categoryId}"].like-btn`);
                console.log(`Î≤ÑÌäº Ï∞æÍ∏∞ (${categoryId}):`, btn ? 'ÏÑ±Í≥µ' : 'Ïã§Ìå®');

                if (btn) {
                    const icon = btn.querySelector('.like-icon');
                    console.log(`ÏïÑÏù¥ÏΩò Ï∞æÍ∏∞ (${categoryId}):`, icon ? 'ÏÑ±Í≥µ' : 'Ïã§Ìå®');

                    if (data.checked) {
                        btn.classList.add('liked');
                        if (icon) icon.textContent = '‚ô•';
                    } else {
                        btn.classList.remove('liked');
                        if (icon) icon.textContent = '‚ô°';
                    }
                }
            }
        } catch (error) {
            console.error('Ï¢ãÏïÑÏöî ÏÉÅÌÉú Î°úÎìú Ïò§Î•ò:', error);
        }
    }

    // Ï¢ãÏïÑÏöî Í∞úÏàò Î°úÎìú
    async function loadLikeCount(categoryId) {
        if (!categoryId) {
            console.error('loadLikeCount: categoryId is missing!');
            return;
        }

        console.log(`loadLikeCount Ìò∏Ï∂ú: ${categoryId}`);
        try {
            const response = await apiCall('/categories/likes/count/${categoryId}');

            if (response.ok) {
                const data = await response.json();
                console.log(`Ï¢ãÏïÑÏöî Í∞úÏàò ÏùëÎãµ (${categoryId}):`, data);

                // Ï†ïÏàò ÎòêÎäî Í∞ùÏ≤¥ ÏùëÎãµ Î™®Îëê ÏßÄÏõê
                const count = typeof data === 'number' ? data : (data.count || 0);

                const countElement = document.getElementById(`like-count-${categoryId}`);
                if (countElement) {
                    countElement.textContent = count;
                    console.log(`Ï¢ãÏïÑÏöî Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏ (${categoryId}): ${count}`);
                }
            }
        } catch (error) {
            console.error('Ï¢ãÏïÑÏöî Í∞úÏàò Î°úÎìú Ïò§Î•ò:', error);
        }
    }

    // ÎåìÍ∏Ä Î™®Îã¨ Ïó¥Í∏∞
    async function openCommentModal(event, categoryId, categoryTitle) {
        event.stopPropagation();

        // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
        if (!currentUser) {
            alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
            return;
        }

        currentCommentCategoryId = categoryId;
        currentCommentCategoryTitle = categoryTitle;
        replyingToCommentId = null;

        document.getElementById('commentModalTitle').textContent = `${categoryTitle} - ${currentLang === 'ko' ? 'ÎåìÍ∏Ä' : 'Comments'}`;
        document.getElementById('commentModal').classList.add('active');
        document.getElementById('commentInput').value = '';

        await loadComments();
    }

    // ÎåìÍ∏Ä Î™®Îã¨ Îã´Í∏∞
    function closeCommentModal() {
        document.getElementById('commentModal').classList.remove('active');
        currentCommentCategoryId = null;
        replyingToCommentId = null;
    }

    // ÎåìÍ∏Ä Î™©Î°ù Î°úÎìú
    async function loadComments() {
        const container = document.getElementById('commentContent');

        try {
            const response = await apiCall('/category/comment/${currentCommentCategoryId}');

            if (response.ok) {
                const comments = await response.json();

                if (comments.length === 0) {
                    const emptyText = currentLang === 'ko' ? 'ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§' : 'No comments';
                    container.innerHTML = `<div class="empty-state">${emptyText}</div>`;
                } else {
                    container.innerHTML = renderComments(comments);
                    applyLanguage();
                }
            } else {
                throw new Error('Failed to load comments');
            }
        } catch (error) {
            console.error('ÎåìÍ∏Ä Î°úÎìú Ïò§Î•ò:', error);
            const errorText = currentLang === 'ko' ? 'ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§' : 'Failed to load comments';
            container.innerHTML = `<div class="empty-state">${errorText}</div>`;
        }
    }

    // ÎåìÍ∏Ä Î†åÎçîÎßÅ
    function renderComments(comments, depth = 0) {
        return comments.map(comment => {
            const indent = depth * 30;
            const authorBadge = comment.mine ? '<span style="background: #ffd700; color: #000; padding: 2px 6px; font-size: 10px; margin-left: 5px; font-weight: 600;">ME</span>' : '';
            const updatedBadge = comment.updated ? `<span style="color: #999; font-size: 11px; margin-left: 5px;">(${currentLang === 'ko' ? 'ÏàòÏ†ïÎê®' : 'edited'})</span>` : '';

            let html = `
                <div style="margin-left: ${indent}px; margin-bottom: 15px; padding: 10px; background: ${comment.mine ? '#fffacd' : '#f9f9f9'}; border-left: 3px solid ${comment.mine ? '#ffd700' : '#ddd'};">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                        <strong>${comment.authorEmail}</strong>${authorBadge}${updatedBadge}
                        <span style="margin-left: 10px; font-size: 11px; color: #999;">${new Date(comment.createdAt).toLocaleString(currentLang === 'ko' ? 'ko-KR' : 'en-US')}</span>
                    </div>
                    <div style="font-size: 13px; margin-bottom: 8px; line-height: 1.5;">${comment.comment}</div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="startReply('${comment.commentId}', '${comment.authorEmail}')" style="padding: 4px 10px; border: 1px solid #999; background: white; cursor: pointer; font-size: 11px;">
                            <span data-lang-ko="ÎãµÍ∏Ä" data-lang-en="Reply">ÎãµÍ∏Ä</span>
                        </button>
                        ${comment.canUpdate ? `<button onclick="editComment('${comment.commentId}', \`${comment.comment.replace(/`/g, '\\`')}\`)" style="padding: 4px 10px; border: 1px solid #999; background: white; cursor: pointer; font-size: 11px;"><span data-lang-ko="ÏàòÏ†ï" data-lang-en="Edit">ÏàòÏ†ï</span></button>` : ''}
                        ${comment.canDelete ? `<button onclick="deleteComment('${comment.commentId}')" style="padding: 4px 10px; border: 1px solid #cc0000; color: #cc0000; background: white; cursor: pointer; font-size: 11px;"><span data-lang-ko="ÏÇ≠Ï†ú" data-lang-en="Delete">ÏÇ≠Ï†ú</span></button>` : ''}
                    </div>
                </div>
            `;

            if (comment.children && comment.children.length > 0) {
                html += renderComments(comment.children, depth + 1);
            }

            return html;
        }).join('');
    }

    // ÎåìÍ∏Ä ÏûëÏÑ±
    async function submitComment() {
        // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
        if (!currentUser) {
            alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
            return;
        }

        const input = document.getElementById('commentInput');
        const comment = input.value.trim();

        if (!comment) {
            alert(currentLang === 'ko' ? 'ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî' : 'Please enter comment');
            return;
        }

        try {
            const url = replyingToCommentId
                ? `${API_BASE}/category/comment/replies`
                : `${API_BASE}/category/comment`;

            const body = replyingToCommentId
                ? { categoryId: currentCommentCategoryId, parentId: replyingToCommentId, comment }
                : { categoryId: currentCommentCategoryId, comment };

            const response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify(body)
            });

            if (response.ok) {
                input.value = '';
                replyingToCommentId = null;
                input.placeholder = currentLang === 'ko' ? 'ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...' : 'Enter comment...';
                await loadComments();
            } else if (response.status === 401) {
                alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
            } else {
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.message || (currentLang === 'ko' ? 'ÎåìÍ∏Ä ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§' : 'Failed to submit comment');
                alert(errorMessage);
            }
        } catch (error) {
            console.error('ÎåìÍ∏Ä ÏûëÏÑ± Ïò§Î•ò:', error);
            alert(currentLang === 'ko' ? 'ÎåìÍ∏Ä ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§' : 'Failed to submit comment');
        }
    }

    // ÎãµÍ∏Ä ÏãúÏûë
    function startReply(commentId, authorEmail) {
        if (!currentUser) {
            alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
            return;
        }

        replyingToCommentId = commentId;
        const input = document.getElementById('commentInput');
        input.placeholder = `${authorEmail}${currentLang === 'ko' ? 'ÎãòÏóêÍ≤å ÎãµÍ∏Ä...' : ' Reply to...'}`;
        input.focus();
    }

    // ÎåìÍ∏Ä ÏàòÏ†ï
    async function editComment(commentId, currentComment) {
        if (!currentUser) {
            alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
            return;
        }

        const newComment = prompt(currentLang === 'ko' ? 'ÎåìÍ∏Ä ÏàòÏ†ï' : 'Edit comment', currentComment);

        if (newComment === null || newComment.trim() === '') return;

        try {
            const response = await apiCall(`/category/comment`, {
                method: 'PATCH',
                body: JSON.stringify({ commentId, comment: newComment.trim() })
            });

            if (response.ok) {
                await loadComments();
            } else if (response.status === 401) {
                alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
            } else if (response.status === 403) {
                alert(currentLang === 'ko' ? 'Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§' : 'Permission denied');
            } else {
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.message || (currentLang === 'ko' ? 'ÎåìÍ∏Ä ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§' : 'Failed to update comment');
                alert(errorMessage);
            }
        } catch (error) {
            console.error('ÎåìÍ∏Ä ÏàòÏ†ï Ïò§Î•ò:', error);
            alert(currentLang === 'ko' ? 'ÎåìÍ∏Ä ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§' : 'Failed to update comment');
        }
    }

    // ÎåìÍ∏Ä ÏÇ≠Ï†ú
    async function deleteComment(commentId) {
        if (!currentUser) {
            alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
            return;
        }

        if (!confirm(currentLang === 'ko' ? 'ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?' : 'Delete this comment?')) return;

        try {
            const response = `await apiCall(`/category/comment/${commentId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                await loadComments();
            } else if (response.status === 401) {
                alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
            } else if (response.status === 403) {
                alert(currentLang === 'ko' ? 'Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§' : 'Permission denied');
            } else {
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.message || (currentLang === 'ko' ? 'ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§' : 'Failed to delete comment');
                alert(errorMessage);
            }
        } catch (error) {
            console.error('ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïò§Î•ò:', error);
            alert(currentLang === 'ko' ? 'ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§' : 'Failed to delete comment');
        }
    }

    // ÎåìÍ∏Ä Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
    document.getElementById('commentModal').addEventListener('click', (e) => {
        if (e.target.id === 'commentModal') {
            closeCommentModal();
        }
    });

    // ÏπúÍµ¨ ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞ (Ïù¥Î©îÏùº Í∏∞Î∞ò)
    async function sendFriendRequest(event, email) {
        event.stopPropagation(); // Ïπ¥ÌÖåÍ≥†Î¶¨ Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ

        if (!currentUser) {
            alert(currentLang === 'ko' ? 'Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§' : 'Login required');
            return;
        }

        if (!confirm(currentLang === 'ko' ? `${email}ÏóêÍ≤å ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇ¥ÏãúÍ≤†ÏäµÎãàÍπå?` : `Send friend request to ${email}?`)) {
            return;
        }

        try {
            // Î®ºÏ†Ä Ïù¥Î©îÏùºÎ°ú ÏÇ¨Ïö©Ïûê IDÎ•º Ï°∞Ìöå
            const userSearchResponse = await apiCall('/user/search?email=${encodeURIComponent(email)}');

            if (!userSearchResponse.ok) {
                alert(currentLang === 'ko' ? 'ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§' : 'User not found');
                return;
            }

            const user = await userSearchResponse.json();

            // ÏπúÍµ¨ ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
            const response = await apiCall(`/friend/requests`, {
                method: 'POST',
                body: JSON.stringify({ toUserId: user.id })
            });

            if (response.ok) {
                alert(currentLang === 'ko' ? 'ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§' : 'Friend request sent');
            } else if (response.status === 400) {
                const errorText = await response.text();
                if (errorText.includes('already')) {
                    alert(currentLang === 'ko' ? 'Ïù¥ÎØ∏ ÏπúÍµ¨Ïù¥Í±∞ÎÇò ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇ∏ ÏÇ¨Ïö©ÏûêÏûÖÎãàÎã§' : 'Already friends or request already sent');
                } else {
                    alert(currentLang === 'ko' ? 'ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇº Ïàò ÏóÜÏäµÎãàÎã§' : 'Cannot send friend request');
                }
            } else {
                alert(currentLang === 'ko' ? 'ÏπúÍµ¨ ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§' : 'Failed to send friend request');
            }
        } catch (error) {
            console.error('ÏπúÍµ¨ ÏöîÏ≤≠ Ïò§Î•ò:', error);
            alert(currentLang === 'ko' ? 'ÏπúÍµ¨ ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§' : 'Failed to send friend request');
        }
    }
</script>

</body>
</html>